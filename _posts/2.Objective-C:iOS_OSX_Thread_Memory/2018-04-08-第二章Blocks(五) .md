---
layout: post
title: "第二章 Blocks(五)"
date: 2018-04-08
description: "Blocks"
tag: Objective-C高级编程：iOS与OS X多线程和内存管理
---


<h6>
  版权声明：本文为博主原创文章，未经博主允许不得转载。
  <a target="_blank" href="https://jianghuhike.github.io/1848.html">
  原文地址：https://jianghuhike.github.io/1848.html 
  </a>
</h6>



## 目录

* [循环引用](#content1)



<!-- ************************************************ -->
## <a id="content1"></a>循环引用
常见的循环引用的场景
```objc
@interface Person : NSObject;
@property (nonatomic, copy) void(^blk)(void);
@end


int main(int argc, char * argv[]) {
    @autoreleasepool {
        
        Person * person = [[Person alloc] init];
        person.blk = ^{
            NSLog(@"person = %@",person);
        };
        
    }
    return 0;
}
```

循环引用示意图
<img src="/images/memory/block8.png" alt="img">

如何解决循环引用的问题       
使用__weak __unsafe_unretained 修饰符
```objc
Person * person = [[Person alloc] init];
__weak typeof(person) weakPerson = person;
__unsafe_unretained typeof(person) weakPerson2 = person;
```

解除循环引用的原理示意图

<img src="/images/memory/block9.png" alt="img">

另外还有一种解决循环引用的方式，但不推荐。但更有助于我们了解循环引用和解除循环引用。
```objc
__block Person * person = [[Person alloc] init];
person.blk = ^{
    NSLog(@"person = %@",person);
    person = nil;
};
person.blk();
```

原理示意图如下

<img src="/images/memory/block10.png" alt="img">

但是必须调用`person.blk();`让`person=nil;`执行才能解除循环引用。




----------
>  行者常至，为者常成！


