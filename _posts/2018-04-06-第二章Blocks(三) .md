---
layout: post
title: "第二章 Blocks(三)"
date: 2018-04-06
description: "Blocks"
tag: Objective-C高级编程：iOS与OS X多线程和内存管理
---


<h6>
  版权声明：本文为博主原创文章，未经博主允许不得转载。
  <a target="_blank" href="https://jianghuhike.github.io/1846.html">
  原文地址：https://jianghuhike.github.io/1846.html 
  </a>
</h6>



## 目录

* [Block的类型](#content1)




<!-- ************************************************ -->
## <a id="content1"></a>Block的类型 

Block的本质是OC对象，那么我们通过下面代码看下它的类及继承关系
```objc
void(^blk)(void)= ^(void){
    
};

NSLog(@"[blk class]= %@",[blk class]);
NSLog(@"[[blk class] superclass]= %@",[[blk class] superclass]);
NSLog(@"[[[blk class] superclass] superclass]= %@",[[[blk class] superclass] superclass]);
NSLog(@"[[[[blk class] superclass] superclass] superclass]= %@",[[[[blk class] superclass] superclass] superclass]);
```
打印日志如下
```objc
[blk class]= __NSGlobalBlock__
[[blk class] superclass]= __NSGlobalBlock
[[[blk class] superclass] superclass]= NSBlock
[[[[blk class] superclass] superclass] superclass]= NSObject
```

可知继承关系为：`__NSGlobalBlock:__NSGlobalBlock:NSBlock:NSObject`

通过代码来看下Block的类型有几种，为了更精确的反应实际情况，<span style="color:red">我们暂时把arc关掉</span>。
```objc
int weight = 80;
int main(int argc, char * argv[]) {
    @autoreleasepool {
        //没有访问auto变量
        void(^blk00)(void)= ^(void){
        };
        NSLog(@"[blk00 class]= %@",[blk00 class]);
        
        //访问全局变量，没有访问auto变量
        void(^blk01)(void)= ^(void){
           NSLog(@"weight=%d",weight);
        };
        NSLog(@"[blk01 class]= %@",[blk01 class]);
        
        //访问静态变量，没有访问auto变量
        static int height = 180;
        void(^blk02)(void)= ^(void){
           NSLog(@"height=%d",height);
        };
        NSLog(@"[blk02 class]= %@",[blk02 class]);

        //访问auto变量
        int age = 10;
        void(^blk1)(void)= ^(void){
            NSLog(@"age=%d",age);
        };
        NSLog(@"[blk1 class]= %@",[blk1 class]);

        //访问auto变量，并执行了copy操作
        NSLog(@"[blk2 class]= %@",[[^(void){NSLog(@"age=%d",age);} copy] class]);
        
    }
    return 0;
}
```

打印日志如下：
```objc
[blk00 class]= __NSGlobalBlock__
[blk01 class]= __NSGlobalBlock__
[blk02 class]= __NSGlobalBlock__
[blk1 class]= __NSStackBlock__
[blk2 class]= __NSMallocBlock__
```
没有访问auto变量的Block类型为：`__NSGlobalBlock__`          
访问了auto变量的Block类型为：`__NSStackBlock__`       
`__NSStackBlock__`类型执行copy操作后类型为： `__NSMallocBlock__`         

Block的内存分配图
<img src="/images/memory/block2.png" alt="img">

每一种类型的Block调用copy后的结果如下图所示：
<img src="/images/memory/block3.png" alt="img">





----------
>  行者常至，为者常成！


