---
layout: post
title: "动态库"
date: 2021-01-06
tag: Objective-C
---


## 目录
- [0401 dead strip](#content1)   
- [0402 动态库原理](#content2)   
- [0403 tbd与符号](#content3)   
- [0404 编译动态库framework](#content4)   
- [0405 image not found的原因](#content5)   
- [0406 ](#content6)   
- [0407 ](#content7)   





 
<!-- ************************************************ -->
## <a id="content1">0401 dead strip</a>

```
echo "-----开始test.o to test EXEC"
clang -target x86_64-apple-macos11.1 \
-fobjc-arc \
-isysroot $SYSROOT \
-Xlinker -all_load \
-Xlinker -dead_strip \
-Xlinker -why_live -Xlinker _global_function \
-L./StaticLibrary \
-lTestExample \
${FILE_NAME}.o -o ${FILE_NAME}


# -dead_strip 官方解释:删除入口点或导出符号无法访问的函数和数据。
Remove functions and data that are unreachable by the entry point or exported symbols.



/**
 情形一:
 -dead_strip 关闭
 global_function:有
 static_function:无

 -dead_strip 打开
 global_function:无
 static_function:无
 */
// 本地
static void static_function() {
    NSLog(@"staticFunction");
}
// 全局
void global_function() {
    NSLog(@"globalFunction");
}
// 入口点
int main(){
    NSLog(@"testApp----");
    return 0;
}



/**
 情形二
 -dead_strip 关闭
 static_function:有
 global_function:有

 
 -dead_strip 打开
 static_function:无
 global_function:无
 */
// 本地
static void static_function() {
    NSLog(@"staticFunction");
}
// 全局
void global_function() {
    NSLog(@"globalFunction");
    static_function();
}
// 入口点
int main(){
    NSLog(@"testApp----");
    return 0;
}




/**
 情形三
 -dead_strip 关闭
 static_function:有
 global_function:有
 global_function2:有

 
 -dead_strip 打开
 static_function:无
 global_function:无
 global_function2:无
 */
// 本地
static void static_function() {
    NSLog(@"staticFunction");
}
// 全局
void global_function() {
    NSLog(@"globalFunction");
    static_function();
}
// 全局2
void global_function2() {
    NSLog(@"globalFunction2");
    global_function();
}

// 入口点
int main(){
    NSLog(@"testApp----");
    return 0;
}


lldb 执行 test可执行文件

└> lldb -file test
(lldb) target create "test"
Current executable set to '/Users/lixiaoyi13/LCFiles/2Content/3Learning/动态库/上课代码/dead strip/test' (x86_64).
(lldb) r

OC没有被干掉,因为动态性
```

<!-- ************************************************ -->
## <a id="content2">0402 动态库原理</a>

**一 动态库介绍**

静态库是.o的合集

动态库是最终链接的产物

动态库比静态库多一步链接的过程,所以动态库不能合并


**二 生成动态库如下**

```
echo "编译TestExample.o --- libTestExample.dylib"

#1 首先变为静态库
libtool -static -arch_only x86_64 TestExample.o -o libTestExample.a

#2 -dynamiclib: 动态库 , dylib 最终链接产物 -》
ld -dylib -arch x86_64 \
-macosx_version_min 11.1 \
-syslibroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX11.1.sdk \
-lsystem -framework Foundation \
-all_load \
libTestExample.a -o libTestExample.dylib
```

或者 
```clang -dynamiclib  \
-target x86_64-apple-macos11.1 \
-fobjc-arc \
-isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX11.1.sdk \
TestExample.o -o libTestExample.dylib
```

**三 链接动态库如下**

```
echo "链接libTestExample.dylib -- test EXEC"
clang -target x86_64-apple-macos11.1 \
-fobjc-arc \
-isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX11.1.sdk \
-L./dylib \
-lTestExample \
test.o -o test
```



<!-- ************************************************ -->
## <a id="content3">0403 tbd与符号</a>

```
Tbd是对动态库的描述文件只有符号没有实现
动态库在编译阶段只知道符号
动态库在运行时通过dyld动态加载
本质是找导出符号在哪个位置
静态库不需要？
```


<!-- ************************************************ -->
## <a id="content4">0404 编译动态库framework</a>
```
```



<!-- ************************************************ -->
## <a id="content5">0405 image not found的原因</a>
```
```



<!-- ************************************************ -->
## <a id="content6">0406</a>
```
动态库将自己的加载路径存储到自身当中
链接的时候可执行文件会将路径拷贝到自己里边
```

<!-- ************************************************ -->
## <a id="content7">0407</a>



----------
>  行者常至，为者常成！


