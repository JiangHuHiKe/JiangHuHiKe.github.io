---
layout: post
title: "KVC"
date: 2018-05-07
description: "NSObject的本质"
tag: 底层原理
---


<h6>
  版权声明：本文为博主原创文章，未经博主允许不得转载。
  <a target="_blank" href="https://jianghuhike.github.io/1857.html">
  原文地址：https://jianghuhike.github.io/1857.html 
  </a>
</h6>


## 目录


- [基本使用](#content1)   
- [分析](#content2)   
- [NSKVONotifying_Person](#content3) 
- [补充](#content4) 




<!-- ************************************************ -->
## <a id="content1"></a>基本使用
KVC的全称是Key-Value Coding,俗称键值编码，可以通过一个key来访问某个属性。

创建一个Person和Cat类    
Person.h     
```objc
NS_ASSUME_NONNULL_BEGIN
@interface Cat:NSObject
@property (nonatomic, assign) float weight;
@end

@interface Person : NSObject;
@property (nonatomic, strong) Cat * cat;
@property (nonatomic, assign) int age;
@end
NS_ASSUME_NONNULL_END
```
Person.m
```objc
#import "Person.h"
@implementation Cat

@end

@implementation Person

@end
```
使用案例
```objc
- (void)viewDidLoad {
    [super viewDidLoad];
    
    Person * person = [[Person alloc] init];
    person.cat = [[Cat alloc] init];
    
    [person addObserver:self
             forKeyPath:@"age"
                options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld
                context:@"123"];
    
    
    [person setValue:@18 forKey:@"age"];
    [person setValue:@10 forKeyPath:@"cat.weight"];
    
    NSLog(@"person.age=%@",[person valueForKey:@"age"]);
    NSLog(@"person.cat.weight=%@",[person valueForKeyPath:@"cat.weight"]);
}


-(void)observeValueForKeyPath:(NSString *)keyPath
                     ofObject:(id)object
                       change:(NSDictionary<NSKeyValueChangeKey,id> *)change
                      context:(void *)context{
    
    NSLog(@"object=%@",object);
    NSLog(@"change=%@",change);
    NSLog(@"context=%@",context);
}
```

打印日志为

```objc
iOSTest[540:67244] object=<Person: 0x2801bbd00>
iOSTest[540:67244] change={
    kind = 1;
    new = 18;
    old = 0;
}
iOSTest[540:67244] context=123
iOSTest[540:67244] person.age=18
iOSTest[540:67244] person.cat.weight=10
```

<!-- ************************************************ -->
## <a id="content2"></a>分析
如上面的例子，我们在添加监听前打个断点，添加监听后打个断点，来看看person1和person2发生了什么变化。      
```objc
//添加监听前：lldb调试
(lldb) po self.person1->isa
Person

(lldb) po self.person2->isa
Person

//添加监听后：lldb调试
(lldb) po self.person1->isa
NSKVONotifying_Person

(lldb) po self.person2->isa
Person
```
可以看出添加了监听的person1的isa指针的指向发生了变化。产生了一个新的类对象，NSKVONotifying_Person。   
   
我们来分析下添加监听后person1->isa指向的类对象NSKVONotifying_Person。

工程中引入 NSObject+classInfo这个分类。[NSObject+classInfo](https://jianghuhike.github.io/1856.html)


```objc
#import "NSObject+classInfo.h"

//添加监听后调用
Class KVO_Person = object_getClass(self.person1);
[KVO_Person printInfoOfClass];

//打印的日志如下
----------- protocol -----------

----------- iVar -----------

----------- property -----------

----------- instanceMethod -----------
instanceMethodName-0 = setAge:
instanceMethodName-1 = class
instanceMethodName-2 = dealloc
instanceMethodName-3 = _isKVOA

----------- classMethod -----------

```

通过以上分析可知：

|(监听前)perosn1->isa 指向 Person类对象|(监听后)person1->isa 指向 NSKVONotifying_Person类对象|
|setAge: |setAge:|
| age    |class|
|        |dealloc|
|        |_isKVOA|


下面再来看下的KVO_Person的superclass指向哪里，可以看出 KVO_Person 的父类是Person类对象。       
```objc
(lldb) p/x [KVO_Person superclass]
(Class) $2 = 0x0000000100059f18 Person
(lldb) p/x [Person class]
(Class) $3 = 0x0000000100059f18 Person
```

<img src="/images/underlying/oc8.png" alt="img">


<!-- ************************************************ -->
## <a id="content3"></a>NSKVONotifying_Person


```objc
#import "NSKVONotifying_MJPerson.h"

@implementation NSKVONotifying_Person

- (void)setAge:(int)age{
    _NSSetIntValueAndNotify();
}

// 伪代码
void _NSSetIntValueAndNotify(){
    [self willChangeValueForKey:@"age"];
    [super setAge:age];
    [self didChangeValueForKey:@"age"];
}

- (void)didChangeValueForKey:(NSString *)key{
    // 通知监听器，某某属性值发生了改变
    [oberser observeValueForKeyPath:key ofObject:self change:nil context:nil];
}

// 屏幕内部实现，隐藏了NSKVONotifying_MJPerson类的存在
- (Class)class{
    return [MJPerson class];
}

- (void)dealloc{
    // 收尾工作
}

- (BOOL)_isKVOA{
    return YES;
}

@end
```

<!-- ************************************************ -->
## <a id="content3"></a>补充
手动触发监听的方法
```objc
[self.person1 willChangeValueForKey:@"age"];
[self.person1 didChangeValueForKey:@"age"];

//或者
self.person1.age = self.person1.age;
```

----------
>  行者常至，为者常成！


