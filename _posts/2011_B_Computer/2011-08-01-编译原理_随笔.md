---
layout: post
title: ç¼–è¯‘åŸç†_éšç¬”
date: 2011-08-01
tag: è®¡ç®—æœºåŸºç¡€
---

## ç›®å½•
- [Object-Cçš„ç¼–è¯‘è¿‡ç¨‹](#content1)
- [Swiftçš„ç¼–è¯‘è¿‡ç¨‹](#content1)



## <a id="content1">Object-Cçš„ç¼–è¯‘è¿‡ç¨‹</a>

æ¯”å¦‚æœ‰å¦‚ä¸‹ä»£ç      
A.m
```objectivec
#import "B.h"
@implementation A
- (void)callTest {
    B *b = [B new];
    [b test];
}
@end
```
B.m
```objectivec

@implementation B
- (void)test {
    NSLog(@"hello");
}
@end
```
A.m ä¸­çš„â€œå¤–éƒ¨ç¬¦å·â€åŒ…æ‹¬ï¼š

```objectivec
ç±» B

æ–¹æ³• test

æ–¹æ³• new

runtime å‡½æ•°å¦‚ objc_msgSend

NSString literal ç­‰ç¬¦å·

```

ä¸‹é¢æˆ‘ä»¬æŒ‰ç¼–è¯‘å™¨æµæ°´çº¿é€æ­¥è§£æ

**1 è¯æ³•åˆ†æ**          
```text
@implementation â†’ keyword
A â†’ identifier
- â†’ token
( â†’ token
void â†’ keyword
) â†’ token
callTest â†’ identifier
{ â†’ token
B â†’ identifier
* â†’ token
b â†’ identifier
= â†’ token
[ â†’ token
B â†’ identifier
new â†’ identifier
] â†’ token
...
```

<span style="color:gray;font-size:12px;">ä»å·¦å‘å³æ‰«æï¼Œå°†å…³é”®å­—ã€æ ‡è¯†ç¬¦ã€å¸¸é‡ã€è¿ç®—ç¬¦ã€ç•Œé™ç¬¦ï¼Œå½¢æˆtokenã€‚</span>          
<span style="color:red;font-size:12px;">æ­¤é˜¶æ®µåªè¯†åˆ«å•è¯ï¼Œä¸æ¶‰åŠâ€œç±» B æ˜¯å¦å­˜åœ¨â€ã€‚ä¸å¤„ç†å¤–éƒ¨ç¬¦å·</span>            

**2 è¯­æ³•åˆ†æ**     
<span style="color:gray;font-size:12px;">åŸºäº Objective-C çš„æ–‡æ³•ï¼ˆgrammarï¼‰ï¼Œç”Ÿæˆ ASTã€‚</span>     
<span style="color:red;font-size:12px;">è¯­æ³•åˆ†æåªè´Ÿè´£ç»“æ„æ­£ç¡®ï¼Œä¸æ£€æŸ¥ç¬¦å·æ˜¯å¦å­˜åœ¨ã€‚</span>    

```text
æ³¨æ„ç‚¹ï¼š

B *b = [B new];

ä¼šè¢«è§£ææˆä¸€ä¸ª ObjC message send è¯­æ³•æ ‘ï¼š

ObjCMessageExpr
   receiver: B (class identifier)
   selector: new
```


**3 è¯­ä¹‰åˆ†æ**     
<span style="color:gray;font-size:12px;">æ‰«æè¯­æ³•æ ‘ï¼Œç”Ÿæˆç¬¦å·è¡¨ã€‚åŒ…æ‹¬Aè‡ªèº«çš„ç¬¦å·å’Œï¼ŒB.hå¯¼å…¥çš„å¤–éƒ¨ç¬¦å·</span>   
<span style="color:gray;font-size:12px;">è¯­ä¹‰åˆ†ææ£€æŸ¥</span>   

æ­¤æ—¶çš„ç¬¦å·è¡¨å¤§æ¦‚é•¿è¿™æ ·
```text
ç¼–è¯‘ A.m çš„ç¬¦å·è¡¨åŒ…å«ï¼š

ğŸ”¹ æ¥è‡ª A.m çš„ç¬¦å·ï¼š
ObjCInterfaceDecl A
 â”œâ”€ ObjCPropertyDecl num
 â”œâ”€ ObjCMethodDecl - num
 â”œâ”€ ObjCMethodDecl - setNum:

ObjCImplementationDecl A
 â””â”€ ObjCMethodDecl - callTest

ğŸ”¹ æ¥è‡ª B.h çš„ç¬¦å·ï¼š
ObjCInterfaceDecl B
 â”œâ”€ ObjCMethodDecl - test
 â”œâ”€ ObjCMethodDecl + new
```


**4 ä¸­é—´ä»£ç ç”Ÿæˆ**

**5 ç”Ÿæˆ.Oæ–‡ä»¶**    

lxy:æ­¤æ—¶å·²ç»å¯¹impåˆ†é…äº†ç›¸å¯¹åœ°å€ã€‚     
æ­¤æ—¶åœ°å€ä¸æ˜¯ç»å¯¹åœ°å€ï¼Œåªæ˜¯ä¸€ä¸ªç¬¦å·ï¼Œåœ°å€æ˜¯åœ¨é“¾æ¥åç¡®å®šçš„

A.o çš„ç¬¦å·è¡¨å¤§æ¦‚ä¼šåŒ…å«ï¼š

```test
#æœ¬åœ°ç¬¦å·ï¼ˆA.m è‡ªå·±çš„ï¼‰         

_OBJC_CLASS_$_A
_I_A_callTest

#å¤–éƒ¨â€œæœªå®šä¹‰ç¬¦å·â€ï¼ˆundefined symbolsï¼‰    
#è¿™äº›å¿…é¡»åœ¨é“¾æ¥é˜¶æ®µè§£å†³ï¼š      
_U_OBJC_CLASS_$_B            â†’ æ¥è‡ª B.o
_objc_msgSend                â†’ æ¥è‡ª libobjc.A.dylib
L_OBJC_SELECTOR_REFERENCES_test â†’ é“¾æ¥åè¢«åˆå¹¶
```

**6 é“¾æ¥é˜¶æ®µ**

é“¾æ¥å™¨ ldï¼š
```text
ä» B.o è·å–ç±» B çš„æ‰€æœ‰ç¬¦å·

ä¸º selector å»é‡ï¼Œä¿è¯ selector å­—ç¬¦ä¸²å”¯ä¸€

åˆå¹¶æ‰€æœ‰ symbol table

ç”Ÿæˆæœ€ç»ˆ Mach-O
```

ld ä¼šä¸ºæ¯ä¸ªç¬¦å·å®‰æ’æœ€ç»ˆå†…å­˜åœ°å€ï¼š

```text
0x100003F20  _OBJC_CLASS_$_A_callTest
```


**7 è¿è¡Œæ—¶ç»‘å®šï¼ˆobjc_msgSendï¼‰**     

æœ€ç»ˆåœ¨è¿è¡Œæ—¶ï¼š
```text
objc_msgSend(b, sel_test)
â†’ åœ¨ç±»Bçš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ test
â†’ è·å– IMP _I_B_test
â†’ è·³è½¬æ‰§è¡Œ

```


## <a id="content2">Swiftçš„ç¼–è¯‘è¿‡ç¨‹</a>






----------
>  Nothing is impossible to a willing heart!