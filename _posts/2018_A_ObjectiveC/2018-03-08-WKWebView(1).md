---
layout: post
title: "WKWebView(1)"
date: 2018-03-08
tag: Objective-C
--- 

- [å‚è€ƒï¼šWKWebViewè¿›é˜¶ä½¿ç”¨æ€»ç»“ - JSäº¤äº’ï¼ˆä¸€ï¼‰](https://juejin.cn/post/7062920887065903117)
- [å‚è€ƒï¼šè¶…è¯¦ç»† WKWebView å¼€å‘å’Œä½¿ç”¨ç»éªŒ](https://www.51cto.com/article/676860.html)    
- [å‚è€ƒï¼šiOSå­¦ä¹ ç¬”è®° â€” WKWebViewçš„ä½¿ç”¨](https://blog.csdn.net/Alexander_Wei/article/details/78360591)   
- [å‚è€ƒï¼šWKWebviewä½¿ç”¨æ”»ç•¥](https://zhuanlan.zhihu.com/p/164502340)   




## ç›®å½•
* [ä»‹ç»](#content1)
* [å¸¸è§„ä½¿ç”¨](#content2)
* [ä¸¤ä¸ªåè®®](#content3)




<!-- ************************************************ -->
## <a id="content1">ä»‹ç»</a>

- [å‚è€ƒæ–‡ç« ï¼šiOS 16.4 ä¹‹åçœŸæœºä¸æ¨¡æ‹Ÿå™¨æ— æ³•ä½¿ç”¨Safariè°ƒè¯•H5é¡µé¢é—®é¢˜](https://blog.csdn.net/weixin_36162680/article/details/134273457)


#### **ä¸€ã€ä»€ä¹ˆæ˜¯WKWebView**   

WKWebView æ˜¯åœ¨iOSä¸­ç”¨äºåŠ è½½å’Œæ˜¾ç¤ºWebå†…å®¹çš„ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒæä¾›äº†ä¸€ç§åœ¨ä½ çš„åº”ç”¨ç¨‹åºä¸­é›†æˆWebæµè§ˆå™¨åŠŸèƒ½çš„æ–¹å¼ã€‚ç†è§£ WKWebView å¯ä»¥ç±»æ¯”ä¸ºä¸€ä¸ªç®€åŒ–çš„æµè§ˆå™¨æ˜¯åˆç†çš„ï¼Œä½†éœ€è¦æ³¨æ„ä¸€äº›ç»†å¾®çš„åŒºåˆ«ã€‚

**1. WKWebView ä½œä¸ºä¸€ä¸ªç®€åŒ–çš„æµè§ˆå™¨ï¼š**    
**åŠ è½½å’Œæ˜¾ç¤ºWebå†…å®¹ï¼š**        
WKWebView è´Ÿè´£åŠ è½½å¹¶æ˜¾ç¤ºWebé¡µé¢ï¼Œæ”¯æŒHTMLã€CSSå’ŒJavaScriptç­‰WebæŠ€æœ¯ã€‚    

**å¯¼èˆªï¼š**       
é€šè¿‡ WKNavigationDelegate åè®®ï¼Œä½ å¯ä»¥æ§åˆ¶Webå¯¼èˆªçš„è¡Œä¸ºï¼Œæ‹¦æˆªè¯·æ±‚ï¼Œå¤„ç†é‡å®šå‘ï¼Œç­‰ç­‰ã€‚

**JavaScriptäº¤äº’ï¼š**     
é€šè¿‡ WKWebView çš„æ–¹æ³•ï¼Œä½ å¯ä»¥ä¸JavaScriptè¿›è¡Œäº¤äº’ï¼Œä»JavaScriptè°ƒç”¨Objective-C/Swiftä»£ç ï¼Œä»¥åŠåœ¨Objective-C/Swiftä¸­è°ƒç”¨JavaScriptä»£ç ã€‚

**Cookieå’Œç¼“å­˜ï¼š**     
WKWebView ç®¡ç†ç€Webé¡µé¢çš„Cookieå’Œç¼“å­˜ï¼Œå¯ä»¥é€šè¿‡ç›¸å…³çš„æ–¹æ³•æ¥è¿›è¡Œæ“ä½œã€‚

**2. åŒºåˆ«ï¼š**       
**æ²¡æœ‰åœ°å€æ ï¼š**     
WKWebView ä¸å…·å¤‡ç±»ä¼¼æ ‡å‡†æµè§ˆå™¨çš„åœ°å€æ å’Œå¯¼èˆªæ§åˆ¶æŒ‰é’®ã€‚ä½ éœ€è¦è‡ªè¡Œå®ç°ç”¨æˆ·ç•Œé¢å…ƒç´ æ¥æ§åˆ¶ WKWebView çš„å¯¼èˆªå’Œæ“ä½œã€‚

**æ²¡æœ‰å¤šæ ‡ç­¾é¡µï¼š**      
WKWebView å®ä¾‹é€šå¸¸è¡¨ç¤ºä¸€ä¸ªå•ç‹¬çš„Webè§†å›¾ï¼Œè€Œä¸æ˜¯å¤šä¸ªæ ‡ç­¾é¡µã€‚å¦‚æœéœ€è¦å®ç°å¤šæ ‡ç­¾é¡µçš„æ•ˆæœï¼Œä½ å¯èƒ½éœ€è¦ç®¡ç†å¤šä¸ª WKWebView å®ä¾‹ã€‚

**å®šåˆ¶åŒ–ï¼š**      
ä¸æ ‡å‡†æµè§ˆå™¨ç›¸æ¯”ï¼ŒWKWebView æä¾›äº†æ›´å¤šçš„å®šåˆ¶å’Œæ§åˆ¶èƒ½åŠ›ï¼Œä½¿å¾—ä½ å¯ä»¥æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€è¦è¿›è¡Œæ›´ç²¾ç»†çš„æ“ä½œã€‚

æ€»ä½“è€Œè¨€ï¼ŒWKWebViewå¯ä»¥è¢«è§†ä¸ºä¸€ä¸ªè½»é‡çº§çš„ã€åµŒå…¥å¼çš„Webæµè§ˆå™¨ç»„ä»¶ï¼Œç”¨äºåœ¨iOSåº”ç”¨ç¨‹åºä¸­é›†æˆWebå†…å®¹ã€‚è™½ç„¶å®ƒä¸åƒæ ‡å‡†æµè§ˆå™¨é‚£æ ·å…·æœ‰å®Œæ•´çš„ç”¨æˆ·ç•Œé¢ï¼Œä½†å´æä¾›äº†è¶³å¤Ÿçš„åŠŸèƒ½æ¥æ»¡è¶³è®¸å¤šåº”ç”¨ç¨‹åºçš„Webé›†æˆéœ€æ±‚ã€‚


#### **äºŒã€è°ƒè¯•**

è§£å†³æ–¹æ³•

```objc
// åœ¨WKWebViewä¸­è®¾ç½®ä»¥ä¸‹ä»£ç è§£å†³
if (@available(iOS 16.4, *)) {
    [_webView setInspectable:YES];
}
```


<!-- ************************************************ -->
## <a id="content2">å¸¸è§„ä½¿ç”¨</a>

#### **ä¸€ã€å‘é€è¯·æ±‚**  

**1ã€åˆå§‹åŒ–**     
```objc
- (WKWebView *)wkWebView {
    if (!_wkWebView) {
        // 1ã€åˆ›å»ºframe
        CGRect frame = CGRectMake(20, 200, self.view.frame.size.width - 40, self.view.frame.size.height - 300);
        
        
        // 2ã€åˆ›å»ºconfig
        WKWebViewConfiguration * config = [[WKWebViewConfiguration alloc] init];
        [config.userContentController addScriptMessageHandler:(id<WKScriptMessageHandler>)[XYProxy proxyWithTarget:self] name:@"getMessage"];
        [config.userContentController addScriptMessageHandler:(id<WKScriptMessageHandler>)[XYProxy proxyWithTarget:self] name:@"ocLog"];
        
        // jsæ³¨å…¥ï¼Œæ³¨å…¥ä¸€ä¸ªalertæ–¹æ³•ï¼Œé¡µé¢åŠ è½½å®Œæ¯•å¼¹å‡ºä¸€ä¸ªå¯¹è¯æ¡†ã€‚
        // WKUserScriptInjectionTimeAtDocumentStartï¼šé¡µé¢åˆšæ¸²æŸ“å‰æ‰§è¡Œï¼Œ
        // WKUserScriptInjectionTimeAtDocumentENDï¼šé¡µé¢æ¸²æŸ“åæ‰§è¡Œã€‚
        // forMainFrameOnly:NO(å…¨å±€çª—å£)ï¼Œyesï¼ˆåªé™ä¸»çª—å£ï¼‰
        NSString *javaScriptSource = @"alert(\"WKUserScriptæ³¨å…¥js\");";
        WKUserScript *userScript = [[WKUserScript alloc] initWithSource:javaScriptSource
                                                          injectionTime:WKUserScriptInjectionTimeAtDocumentEnd
                                                       forMainFrameOnly:YES];
        // [config.userContentController addUserScript:userScript];

        
        
        // 3ã€åˆ›å»ºwkwebviewå®ä¾‹
        _wkWebView = [[WKWebView alloc] initWithFrame:frame configuration:config];
        // ä¸¤ä¸ªå…³é”®åè®®
        _wkWebView.navigationDelegate = self;
        _wkWebView.UIDelegate = self;
        //å¼€å¯safariè°ƒè¯•
        if (@available(iOS 16.4, *)) { [_wkWebView setInspectable:YES];}
        
        // å¸¸è§„è®¾ç½®
        _wkWebView.backgroundColor = [UIColor grayColor];
        _wkWebView.scrollView.backgroundColor = [UIColor clearColor];
        //æ˜¯å¦å…è®¸å·¦å³åˆ’æ‰‹åŠ¿å¯¼èˆªï¼Œé»˜è®¤ä¸å…è®¸
        _wkWebView.allowsBackForwardNavigationGestures = YES;
    }
    return _wkWebView;
}
```

**2ã€å‘é€è¯·æ±‚**    
```objc
- (void)sendRequest{
    
//    NSString * url = [[NSBundle xy_bundleName:@"XYTestModule"] pathForResource:@"test.html" ofType:nil];
    NSString * url = @"http://www.baidu.com";

    
    [self.view addSubview:self.wkWebView];
    
    
    // æ¸…é™¤webviewçš„ç¼“å­˜
    [self __cleanWKWebViewCache];

   
    // åŠ è½½è¿›åº¦æ¡è®¾ç½®
    self.progresslayer = [self __observeProgressForWkWebView:self.wkWebView];
    
    
    // åŠ è½½url
    if (url) {
        if ([url hasPrefix:@"http"]) { //åŠ è½½ç½‘ç»œæ–‡ä»¶
            NSMutableURLRequest *req = [NSMutableURLRequest requestWithURL:[NSURL URLWithString:url]];
            [self.wkWebView loadRequest:req];
            
        } else {//åŠ è½½æœ¬åœ°æ–‡ä»¶
            NSURL * fileUrl = [NSURL fileURLWithPath:url];
            /**
             åŒ…å«æ‚¨æˆäºˆç³»ç»Ÿè¯»å–æƒé™çš„webå†…å®¹çš„æ–‡ä»¶æˆ–ç›®å½•çš„URLã€‚
             æ­¤URLå¿…é¡»æ˜¯åŸºäºæ–‡ä»¶çš„URLï¼Œå¹¶ä¸”ä¸èƒ½ä¸ºç©ºã€‚
             ä¸ºäº†é˜²æ­¢WebKitè¯»å–ä»»ä½•å…¶ä»–å†…å®¹ï¼Œè¯·æŒ‡å®šä¸URLå‚æ•°ç›¸åŒçš„å€¼ã€‚
             è¦è¯»å–ä¸å†…å®¹æ–‡ä»¶ç›¸å…³çš„å…¶ä»–æ–‡ä»¶ï¼Œè¯·æŒ‡å®šä¸€ä¸ªç›®å½•ã€‚
             */
            [self.wkWebView loadFileURL:fileUrl allowingReadAccessToURL:fileUrl];
        }
    }
}
```

#### **äºŒã€å‰è¿›åé€€äº‹ä»¶**   
```objc
if ([self.wkWebView canGoBack]) {
    [self.wkWebView goBack];
}

if ([self.wkWebView canGoForward]) {
    [self.wkWebView goForward];
}
```


#### **ä¸‰ã€ç›‘å¬äº‹ä»¶**    

**1ã€ç›‘å¬äº‹ä»¶æ±‡æ€»**    
```objc
- (void)addObserverForKeyPath {
    
    /**
     title: ç½‘é¡µçš„æ ‡é¢˜ï¼Œä¸€èˆ¬ä¸º html ä¸­çš„ ä¸­çš„å†…å®¹
     URL: ç½‘é¡µçš„URLåœ°å€ï¼Œä¸ºæœ€ç»ˆåŠ è½½çš„åœ°å€
     loading: ç½‘é¡µæ˜¯å¦å¤„äºåŠ è½½ä¸­ï¼ŒYES åŠ è½½ä¸­ã€ NO åŠ è½½å®Œæˆ
     estimatedProgress: ç½‘é¡µåŠ è½½è¿›åº¦
     hasOnlySecureContent: ç½‘é¡µä¸Šçš„æ‰€æœ‰èµ„æºæ˜¯å¦å·²é€šè¿‡ https åŠ è½½
     serverTrust: åŠ è½½ HTTPS è¯·æ±‚æœåŠ¡ç«¯æ‰€ä¿¡ä»»çš„è¯ä¹¦
     
     */
    //Â NSKeyValueObservingOptionNewÂ æ›´æ”¹åçš„å€¼
    //Â NSKeyValueObservingOptionOldÂ æ›´æ”¹å‰çš„å€¼
    //Â NSKeyValueObservingOptionInitialÂ è§‚å¯Ÿåˆå§‹åŒ–çš„å€¼ï¼ˆåœ¨æ³¨å†Œè§‚å¯ŸæœåŠ¡æ—¶ä¼šè°ƒç”¨ä¸€æ¬¡è§¦å‘æ–¹æ³•ï¼‰
    //Â NSKeyValueObservingOptionPriorÂ åˆ†åˆ«åœ¨å€¼ä¿®æ”¹å‰åè§¦å‘æ–¹æ³•ï¼ˆå³ä¸€æ¬¡ä¿®æ”¹æœ‰ä¸¤æ¬¡è§¦å‘ï¼‰
    [self.webView addObserver:self forKeyPath:@"title" options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld context:NULL];
    [self.webView addObserver:self forKeyPath:@"URL" options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld context:NULL];
    [self.webView addObserver:self forKeyPath:@"loading" options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld context:NULL];
    [self.webView addObserver:self forKeyPath:@"estimatedProgress" options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld context:NULL];
    [self.webView addObserver:self forKeyPath:@"hasOnlySecureContent" options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld context:NULL];
    [self.webView addObserver:self forKeyPath:@"serverTrust" options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld context:NULL];
}
```

**2ã€é€šè¿‡ç›‘å¬å±•ç¤ºåŠ è½½è¿›åº¦æ¡**   

```objc
self.progresslayer = [self __observeProgressForWkWebView:self.wkWebView];

-(CALayer*)__observeProgressForWkWebView:(WKWebView*)weView{
    [weView addObserver:self forKeyPath:@"estimatedProgress" options:NSKeyValueObservingOptionNew context:nil];
    UIView *progress = [[UIView alloc]initWithFrame:CGRectMake(0, 0, self.view.frame.size.width, 3)];
    progress.backgroundColor = [UIColor clearColor];
    [weView addSubview:progress];
    
    CALayer *layer = [CALayer layer];
    layer.frame = CGRectMake(0, 0, 0, 3);
    UIColor *tintColor = [UIColor blueColor];
    layer.backgroundColor = tintColor.CGColor;
    [progress.layer addSublayer:layer];
    return layer;
}


- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary<NSString *,id> *)change context:(void *)context{
    if ([keyPath isEqualToString:@"estimatedProgress"]) {
        self.progresslayer.opacity = 1;
        //ä¸è¦è®©è¿›åº¦æ¡å€’ç€èµ°...æœ‰æ—¶å€™gobackä¼šå‡ºç°è¿™ç§æƒ…å†µ
        if ([change[@"new"] floatValue] < [change[@"old"] floatValue]) { return;}
        
        self.progresslayer.frame = CGRectMake(0, 0, self.view.bounds.size.width * [change[@"new"] floatValue], 3);
        if ([change[@"new"] floatValue] == 1) {
            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(.4 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
                self.progresslayer.opacity = 0;
            });
            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(.5 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
                self.progresslayer.frame = CGRectMake(0, 0, 0, 3);
            });
        }
    }else{
        [super observeValueForKeyPath:keyPath ofObject:object change:change context:context];
    }
}

-(void)dealloc{
    [self.wkWebView removeObserver:self forKeyPath:@"estimatedProgress"];
    [[NSNotificationCenter defaultCenter] removeObserver:self];
}
```

#### **4ã€ä¿®æ”¹è¯·æ±‚å¤´çš„UserAgent**   
ä¿®æ”¹æˆåŠŸä¹‹åå†è¿›è¡Œurlçš„åŠ è½½ï¼Œæ‰€ä»¥éœ€è¦å†blockå†…åš `[self.wkWebView loadRequest:req];`       
å¯ä»¥åœ¨è¿™ä¸ªä»£ç†æ–¹æ³•å†…`webView:decidePolicyForNavigationAction:decisionHandler:`æŸ¥çœ‹æ˜¯å¦ä¿®æ”¹æˆåŠŸ       

```objc
-(void)changeUserAgentWithBlock:(void(^)(void))block{
    /**
     * æ§åˆ¶è®¿é—®æƒé™
     * ä¸ºäº†é˜²æ­¢ç”¨æˆ·åˆ†äº«é€ æˆçš„å®‰å…¨éšæ‚£ï¼ˆåˆ†äº«çš„é—®é¢˜ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä¼šæ”¹ï¼‰ï¼Œç›®å‰ï¼Œæˆ‘ä»¬å»ºè®®H5é¡µé¢å¯¹User-Agentè¿›è¡Œåˆ¤æ–­ï¼š
     * 1. è‹¹æœæ‰‹æœºï¼šæå–iPhoneå…³é”®å­—ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰shoudanå…³é”®å­—ï¼Œæ²¡æœ‰åˆ™æ‹’ç»è®¿é—®ã€‚
     * 2. å®‰å“æ‰‹æœºï¼šæå–Androidå…³é”®å­—ï¼Œåˆ¤æ–­æ˜¯å­˜åŒ…å«å¾®ä¿¡ï¼ˆMicroMessengerï¼‰ã€QQæµè§ˆå™¨ï¼ˆMQQBrowserï¼‰ã€UCæµè§ˆå™¨ã€æ–°æµªç­‰ä¸»æµå¹³å°çš„ä¿¡æ¯ï¼ŒåŒ…å«åˆ™æ‹’ç»è®¿é—®ã€‚
     * 3. ä¸åŒ…å«iPhoneå’ŒAndroidå…³é”®å­—çš„ï¼Œå…¨éƒ¨æ‹’ç»è®¿é—®ã€‚
     */
    
    // wkwebviewè·å–userAgentä¿®æ”¹userAgent
    // æ³¨æ„ï¼šè¿™æ˜¯å¼‚æ­¥æ“ä½œ
    // åˆ›å»ºä¸€ä¸ª WKWebView å®ä¾‹ï¼Œä½¿ç”¨ CGRectZero è¿›è¡Œåˆå§‹åŒ–ï¼Œå¯ä»¥åœ¨ç¨åè®¾ç½®å®é™…çš„ frame
    WKWebView *wkWebView = self.wkWebView;
    
    // ä½¿ç”¨ WKWebView çš„ evaluateJavaScript æ–¹æ³•æ‰§è¡Œ JavaScript ä»£ç 
    // navigator æ˜¯ JavaScript ä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­çš„ userAgent å±æ€§è¿”å›å½“å‰æµè§ˆå™¨çš„ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²ã€‚
    [wkWebView evaluateJavaScript:@"navigator.userAgent" completionHandler:^(id result, NSError *error) {
        // åœ¨ JavaScript æ‰§è¡Œå®Œæˆåï¼Œå¤„ç†è¿”å›çš„ç»“æœæˆ–é”™è¯¯
        
        // å°† JavaScript è¿”å›çš„ç»“æœå¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²
        NSString *userAgent = result;
        
        // åœ¨åŸæœ‰çš„ UserAgent åé¢æ·»åŠ è‡ªå®šä¹‰çš„æ ‡è¯† "/shoudan"
        NSString *newUserAgent = [userAgent stringByAppendingString:@"/shoudan"];
        
        // åˆ›å»ºä¸€ä¸ªåŒ…å«æ–° UserAgent çš„å­—å…¸
        NSDictionary *dictionary = [NSDictionary dictionaryWithObjectsAndKeys:newUserAgent, @"UserAgent", nil];

        // ä½¿ç”¨ NSUserDefaults æ³¨å†Œé»˜è®¤å€¼ï¼Œè¿™é‡Œæ˜¯ä¸ºäº†åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­å…±äº«è¿™ä¸ª UserAgent
        [[NSUserDefaults standardUserDefaults] registerDefaults:dictionary];

        // ç«‹å³åŒæ­¥ UserDefaultsï¼Œç¡®ä¿æ–°çš„ UserAgent ç«‹å³ç”Ÿæ•ˆ
        [[NSUserDefaults standardUserDefaults] synchronize];
        
        // å°†æ–°çš„ UserAgent è®¾ç½®ç»™ WKWebView
        // é€šè¿‡è°ƒç”¨ setCustomUserAgent: æ–¹æ³•ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥å°†è‡ªå®šä¹‰çš„ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²è®¾ç½®ç»™ WKWebView å¯¹è±¡ï¼Œä½¿å¾—åç»­è¯¥ WebView å‘é€çš„ HTTP è¯·æ±‚ä¸­éƒ½ä¼šæºå¸¦è¿™ä¸ªè‡ªå®šä¹‰çš„ç”¨æˆ·ä»£ç†ä¿¡æ¯ã€‚
        // è¿™æ ·ï¼ŒæœåŠ¡å™¨åœ¨å¤„ç†è¯·æ±‚æ—¶å¯ä»¥æ ¹æ®è¿™ä¸ªè‡ªå®šä¹‰ä¿¡æ¯æ¥åŒºåˆ†å¹¶æä¾›ç‰¹å®šçš„æœåŠ¡æˆ–å†…å®¹ã€‚
        [wkWebView setCustomUserAgent:newUserAgent];
        
        if (block) {
            block();
        }
    }];
}
```



<!-- ************************************************ -->
## <a id="content3">ä¸¤ä¸ªåè®®</a>

**1ã€WKNavigationDelegate**       
ä¸»è¦å¤„ç†ä¸€äº›è·³è½¬ã€åŠ è½½å¤„ç†æ“ä½œ    

```text
  ç”¨æˆ·è§¦å‘åŠ è½½ (ç‚¹å‡»é“¾æ¥ / loadRequest / JS è·³è½¬)
  â”‚
  â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ decidePolicyForNavigationAction â”‚
  â”‚  ï¼ˆæ˜¯å¦å…è®¸è¿™æ¬¡è·³è½¬ï¼Ÿï¼‰          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€â”€ decisionHandler(.cancel) â†’ å–æ¶ˆåŠ è½½
              â”‚
              â””â”€â”€ decisionHandler(.allow) â†’ å…è®¸åŠ è½½
  â”‚
  â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”
  â”‚ didStartProvisionalNavigation â”‚
  â”‚ ï¼ˆå¼€å§‹åŠ è½½è¯·æ±‚ï¼Œè¿›å…¥ provisional çŠ¶æ€ï¼‰â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ didReceiveServerRedirectForProvisionalNavigation â”‚
  â”‚   ï¼ˆå¦‚æœæœ‰ 301/302 é‡å®šå‘ä¼šè°ƒç”¨ï¼‰                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ decidePolicyForNavigationResponse           â”‚
  â”‚   æ”¶åˆ°æœåŠ¡å™¨å“åº” Headerï¼Œæ˜¯å¦ç»§ç»­å¤„ç†ï¼Ÿï¼‰        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€â”€ decisionHandler(.cancel) â†’ æ‹¦æˆªå“åº”ï¼ˆæ¯”å¦‚æ–‡ä»¶ä¸‹è½½ï¼‰
              â”‚
              â””â”€â”€ decisionHandler(.allow) â†’ ç»§ç»­åŠ è½½
  â”‚
  â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ didCommitNavigation          â”‚
  â”‚  ï¼ˆå†…å®¹å¼€å§‹è¿”å›å¹¶æäº¤åˆ° WebViewï¼‰â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ didFinishNavigation          â”‚
  â”‚   ï¼ˆé¡µé¢åŠ è½½å®Œæˆï¼‰              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â””â”€â”€â–º [å¯é€‰] didFailProvisionalNavigation / didFailNavigation
  ï¼ˆåŠ è½½å¤±è´¥æ—¶ä¼šèµ°è¿™é‡Œï¼‰

```

``` objc

// æ˜¯å¦å…è®¸è¿™æ¬¡è·³è½¬ï¼Ÿ
- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler{
    
    NSLog(@"----åœ¨å‘é€è¯·æ±‚ä¹‹å‰ï¼Œå†³å®šæ˜¯å¦è·³è½¬ï¼š%@",webView.URL);

    if (navigationAction.targetFrame.isMainFrame) {
        NSLog(@"ğŸ‘‰ ä¸»æ¡†æ¶åŠ è½½: %@", navigationAction.request.URL.absoluteString);
    } else {
        NSLog(@"ğŸ‘‰ iframe åŠ è½½: %@", navigationAction.request.URL.absoluteString);
    }
    
    NSURL* url = webView.URL;
    NSLog(@"url=%@",url);
    if ([url.scheme isEqualToString:@"event"]) {
        NSLog(@"jsCallNativeTwo");
    }else{
        NSLog(@"æ‰“å¼€é¡µé¢");
    }
    
    
    //è®¾ç½®è¯·æ±‚å¤´ï¼šåˆ¤æ–­è¯·æ±‚å¤´æ˜¯å¦å­˜åœ¨Testå­—æ®µï¼Œå¦‚æœå¦ï¼Œåˆ™è¡¨ç¤ºè¯¥è¯·æ±‚å°šæœªè®¾ç½®è¯·æ±‚å¤´
    NSMutableURLRequest *mutableRequest = [navigationAction.request mutableCopy];
    NSDictionary *headFields = mutableRequest.allHTTPHeaderFields;
    if(![headFields objectForKey:@"Test"]){
        NSLog(@"[lilog]:ä¸åŒ…å«");
        decisionHandler(WKNavigationActionPolicyCancel);
        //å¦‚æœTestä¸å­˜åœ¨ä¼šåˆ›å»ºï¼Œå­˜åœ¨ä¼šæ›´æ–°Testå¯¹åº”çš„value Test:"test"
        [mutableRequest setValue:@"test" forHTTPHeaderField:@"Test"];
        //å¦‚æœTestä¸å­˜åœ¨ä¼šåˆ›å»ºï¼Œå­˜åœ¨ä¼šè¿½åŠ Testå¯¹åº”çš„value Test:"test,add"
        [mutableRequest addValue:@"add" forHTTPHeaderField:@"Test"];
        [webView loadRequest:mutableRequest];
    }else{
        NSLog(@"[lilog]:åŒ…å«");
        decisionHandler(WKNavigationActionPolicyAllow);
    }
    
    //å…è®¸è·³è½¬
    //decisionHandler(WKNavigationActionPolicyAllow);
    
    //ä¸å…è®¸è·³è½¬
    //decisionHandler(WKNavigationActionPolicyCancel);
}


// å¼€å§‹åŠ è½½è¯·æ±‚ï¼Œè¿›å…¥ provisional çŠ¶æ€
- (void)webView:(WKWebView *)webView didStartProvisionalNavigation:(WKNavigation *)navigation {
    NSLog(@"----é¡µé¢å¼€å§‹åŠ è½½:%@",webView.URL);
}


// å¦‚æœæœ‰ 301/302 é‡å®šå‘ä¼šè°ƒç”¨
- (void)webView:(WKWebView *)webView didReceiveServerRedirectForProvisionalNavigation:(WKNavigation *)navigation {
  NSLog(@"----æ¥æ”¶åˆ°æœåŠ¡å™¨è·³è½¬è¯·æ±‚ä¹‹åè°ƒç”¨:%@",webView.URL);
  /**
  å®ƒå¯èƒ½å¹¶ä¸ä¼šè¢«æ‰€æœ‰çš„é‡å®šå‘è§¦å‘ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒWKWebView ä¼šè‡ªåŠ¨å¤„ç†é‡å®šå‘ï¼Œè€Œä¸ä¼šé€šçŸ¥åˆ°åº”ç”¨ç¨‹åºçš„ WKNavigationDelegateã€‚

  åœ¨ä½ çš„ä¾‹å­ä¸­ï¼Œç™¾åº¦çš„ç½‘å€ http://www.baidu.com ç¡®å®ä¼šè¢«é‡å®šå‘åˆ° https://www.baidu.comï¼Œ
  ä½†æ˜¯è¿™ä¸ªé‡å®šå‘å¯èƒ½åœ¨ WKWebView å†…éƒ¨å¤„ç†ï¼Œè€Œä¸ä¼šè§¦å‘ didReceiveServerRedirectForProvisionalNavigation æ–¹æ³•ã€‚

  å¦‚æœä½ éœ€è¦å¤„ç†è¿™ç§é‡å®šå‘ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ WKNavigationDelegate çš„å…¶ä»–æ–¹æ³•ï¼Œæ¯”å¦‚ didCommitNavigation æˆ– didFinishNavigationã€‚
  åœ¨è¿™äº›æ–¹æ³•ä¸­ï¼Œä½ å¯ä»¥æ£€æŸ¥å®é™…åŠ è½½çš„ URLï¼Œä»¥ä¾¿ç¡®å®šæ˜¯å¦å‘ç”Ÿäº†é‡å®šå‘ã€‚
  */
}

// æ”¶åˆ°æœåŠ¡å™¨å“åº” Headerï¼Œæ˜¯å¦ç»§ç»­å¤„ç†ï¼Ÿ
- (void)webView:(WKWebView *)webView decidePolicyForNavigationResponse:(WKNavigationResponse *)navigationResponse decisionHandler:(void (^)(WKNavigationResponsePolicy))decisionHandler {

    if (navigationResponse.forMainFrame) {
      NSLog(@"ğŸ‘‰ ä¸»æ¡†æ¶å“åº”: %@", navigationResponse.response.URL.absoluteString);
    } else {
      NSLog(@"ğŸ‘‰ iframe å“åº”: %@", navigationResponse.response.URL.absoluteString);
    }
    
    NSHTTPURLResponse *httpResponse = (NSHTTPURLResponse *)navigationResponse.response;
    if (httpResponse.statusCode == 200) {
        // å…è®¸åŠ è½½
        decisionHandler(WKNavigationResponsePolicyAllow);
    } else {
        // å–æ¶ˆåŠ è½½
        decisionHandler(WKNavigationResponsePolicyCancel);
    }
}


// å†…å®¹å¼€å§‹è¿”å›å¹¶æäº¤åˆ° WebView
- (void)webView:(WKWebView *)webView didCommitNavigation:(WKNavigation *)navigation {
    NSLog(@"----é¡µé¢è¿”å›å†…å®¹:%@",webView.URL);
    // æ£€æŸ¥å½“å‰åŠ è½½çš„URLæ˜¯å¦ä¸åŸå§‹è¯·æ±‚çš„URLä¸åŒï¼Œå³å‘ç”Ÿäº†é‡å®šå‘
    if (![webView.URL.absoluteString isEqualToString:@"http://www.baidu.com"]) {
        NSLog(@"----é‡å®šå‘åˆ°: %@", webView.URL);
        // åœ¨è¿™é‡Œå¯ä»¥æ‰§è¡Œç›¸åº”çš„æ“ä½œ
    }
}


// é¡µé¢åŠ è½½å®Œæˆ
- (void)webView:(WKWebView *)webView didFinishNavigation:(WKNavigation *)navigation {
    // åŠ è½½å®Œæˆåçš„å¤„ç†ï¼Œå¯ä»¥ç”¨äºæ›´æ–°ç•Œé¢æˆ–æ‰§è¡Œå…¶ä»–æ“ä½œ
    NSLog(@"----é¡µé¢æ¸²æŸ“å®Œæˆ:%@",webView.URL);
}


// åŠ è½½å¤±è´¥æ—¶ä¼šèµ°è¿™é‡Œ
- (void)webView:(WKWebView *)webView didFailNavigation:(WKNavigation *)navigation withError:(NSError *)error {
    NSLog(@"----é¡µé¢åŠ è½½å¤±è´¥:%@",webView.URL);
}





// å¤„ç†èº«ä»½éªŒè¯æŒ‘æˆ˜
- (void)webView:(WKWebView *)webView didReceiveAuthenticationChallenge:(NSURLAuthenticationChallenge *)challenge completionHandler:(void (^)(NSURLSessionAuthChallengeDisposition, NSURLCredential * _Nullable))completionHandler {
    NSLog(@"----èº«ä»½è®¤è¯:%@",webView.URL);
    BOOL isAllow = YES;// æ£€æŸ¥èº«ä»½éªŒè¯æ¡ä»¶
    if (isAllow) {
        NSURLCredential *credential = [NSURLCredential credentialWithUser:@"username" password:@"password" persistence:NSURLCredentialPersistenceForSession];
        completionHandler(NSURLSessionAuthChallengeUseCredential, credential);
    } else {
        completionHandler(NSURLSessionAuthChallengeCancelAuthenticationChallenge, nil);
    }
}
```


** 2ã€WKUIDelegate **     
ä¸»è¦å¤„ç†JSè„šæœ¬ï¼Œç¡®è®¤æ¡†ï¼Œè­¦å‘Šæ¡†ç­‰ã€‚    

```objc
// å½“ H5 æ‰§è¡Œ window.close() æ–¹æ³•ï¼Œåˆ™ä¼šæ‰§è¡Œè¿™ä¸ªä»£ç†æ–¹æ³•ã€‚
- (void)webViewDidClose:(WKWebView *)webView {
    
}


- (nullable WKWebView *)webView:(WKWebView *)webView
 createWebViewWithConfiguration:(WKWebViewConfiguration *)configuration
            forNavigationAction:(WKNavigationAction *)navigationAction
                 windowFeatures:(WKWindowFeatures *)windowFeatures {
    
    /**
     åœ¨ä½¿ç”¨WKWebviewæ—¶å‘ç°æœ‰äº›ä¸‰æ–¹é¡µé¢ç‚¹å‡»é“¾æ¥ä¸è·³è½¬çš„é—®é¢˜ï¼ŒæŸ¥é˜…ç›¸å…³èµ„æ–™åå‘ç°ï¼Œ
     ç”¨æˆ·ç‚¹å‡»ç½‘é¡µä¸Šçš„é“¾æ¥ï¼Œéœ€è¦æ‰“å¼€æ–°é¡µé¢æ—¶ï¼Œå°†å…ˆè°ƒç”¨decidePolicyForNavigationActionæ–¹æ³•ï¼Œ
     å…¶ä¸­çš„WKNavigationActionæœ‰ä¸¤ä¸ªå±æ€§sourceFrameå’ŒtargetFrameï¼Œç±»å‹æ˜¯WKFrameInfoï¼Œ
     WKFrameInfoçš„mainFrameå±æ€§æ ‡è®°ç€è¿™ä¸ªframeæ˜¯åœ¨ä¸»frameé‡Œè¿˜æ˜¯æ–°å¼€ä¸€ä¸ªframeã€‚
     
     å¦‚æœ targetFrameçš„mainFrameå±æ€§ä¸ºNOï¼Œå°†ä¼šæ–°å¼€ä¸€ä¸ªé¡µé¢ï¼Œ
     WKWebViewé‡åˆ°è¿™ç§æƒ…å†µï¼Œå°†ä¼šè°ƒç”¨å®ƒçš„WKUIDelegateä»£ç†ä¸­çš„createWebViewWithConfigurationæ–¹æ³•ï¼Œ
     æ‰€ä»¥å¦‚æœæˆ‘ä»¬ä¸å®ç°è¿™ä¸ªåè®®å°±ä¼šå‡ºç°ç‚¹å‡»æ— ååº”çš„æƒ…å†µï¼Œå› æ­¤å¯¹äºè¿™ç§æƒ…å†µéœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå¯ä»¥é‡‡å–ä¸‹è¾¹çš„æ–¹æ³•ï¼š
     ç›¸å½“äºæ”¾å¼ƒåŸæ¥é¡µé¢ç›´æ¥æ‰“å¼€æ–°çš„é¡µé¢ã€‚
     
     // ä¸ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•
     <a href="https://www.baidu.com">è·³è½¬åˆ°ç™¾åº¦ï¼Œå½“å‰é¡µé¢æ‰“å¼€</a><br>
     
     // åœ¨æ–°çš„æ ‡ç­¾ä¹Ÿä¸­æ‰“å¼€æ—¶ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•
     <a href="https://www.baidu.com" target="_blank">è·³è½¬åˆ°ç™¾åº¦ï¼Œæ–°é¡µé¢æ‰“å¼€</a>
     */
    WKFrameInfo *frameInfo = navigationAction.targetFrame;
    if (![frameInfo isMainFrame]) {
        [webView loadRequest:navigationAction.request];
    }
    return nil;
}


/**
 WKUIDelegateæ˜¯webç•Œé¢ä¸­æœ‰å¼¹å‡ºè­¦å‘Šæ¡†æ—¶è°ƒç”¨è¿™ä¸ªä»£ç†æ–¹æ³•,ä¸»è¦æ˜¯ç”¨æ¥å¤„ç†ä½¿ç”¨ç³»ç»Ÿçš„å¼¹æ¡†æ¥æ›¿æ¢JSä¸­çš„ä¸€äº›å¼¹æ¡†çš„,æ¯”å¦‚: è­¦å‘Šæ¡†, é€‰æ‹©æ¡†, è¾“å…¥æ¡†ç­‰
 webViewä¸­å¼¹å‡ºè­¦å‘Šæ¡†æ—¶è°ƒç”¨, åªèƒ½æœ‰ä¸€ä¸ªæŒ‰é’®
 @param webView webView
 @param message æç¤ºä¿¡æ¯
 @param frame å¯ç”¨äºåŒºåˆ†å“ªä¸ªçª—å£è°ƒç”¨çš„
 @param completionHandler è­¦å‘Šæ¡†æ¶ˆå¤±çš„æ—¶å€™è°ƒç”¨, å›è°ƒç»™JS
 */
- (void)webView:(WKWebView *)webView runJavaScriptAlertPanelWithMessage:(NSString *)message initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(void))completionHandler {
    
    UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"æ¸©é¦¨æç¤º" message:message preferredStyle:UIAlertControllerStyleAlert];
    [alert addAction:[UIAlertAction actionWithTitle:@"ç¡®å®š" style:UIAlertActionStyleCancel handler:nil]];
    [self presentViewController:alert animated:YES completion:nil];
    completionHandler();
}

/** å¯¹åº”jsçš„confirmæ–¹æ³•
 webViewä¸­å¼¹å‡ºé€‰æ‹©æ¡†æ—¶è°ƒç”¨, ä¸¤ä¸ªæŒ‰é’®
 @param webView webView description
 @param message æç¤ºä¿¡æ¯
 @param frame å¯ç”¨äºåŒºåˆ†å“ªä¸ªçª—å£è°ƒç”¨çš„
 @param completionHandler ç¡®è®¤æ¡†æ¶ˆå¤±çš„æ—¶å€™è°ƒç”¨, å›è°ƒç»™JS, å‚æ•°ä¸ºé€‰æ‹©ç»“æœ: YES or NO
 */
- (void)webView:(WKWebView *)webView runJavaScriptConfirmPanelWithMessage:(NSString *)message initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(BOOL))completionHandler{
    //    DLOG(@"msg = %@ frmae = %@",message,frame);
    UIAlertController *alertController = [UIAlertController alertControllerWithTitle:@"æç¤º" message:message?:@"" preferredStyle:UIAlertControllerStyleAlert];
    [alertController addAction:([UIAlertAction actionWithTitle:@"å–æ¶ˆ" style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) {
        completionHandler(NO);
    }])];
    [alertController addAction:([UIAlertAction actionWithTitle:@"ç¡®è®¤" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        completionHandler(YES);
    }])];
    
    [self presentViewController:alertController animated:YES completion:nil];
}


/** å¯¹åº”jsçš„promptæ–¹æ³•
 webViewä¸­å¼¹å‡ºè¾“å…¥æ¡†æ—¶è°ƒç”¨, ä¸¤ä¸ªæŒ‰é’® å’Œ ä¸€ä¸ªè¾“å…¥æ¡†
 JavaScriptè°ƒç”¨promptæ–¹æ³•åå›è°ƒçš„æ–¹æ³• promptæ˜¯jsä¸­çš„è¾“å…¥æ¡† éœ€è¦åœ¨blockä¸­æŠŠç”¨æˆ·è¾“å…¥çš„ä¿¡æ¯ä¼ å…¥
 @param webView webView description
 @param prompt æç¤ºä¿¡æ¯
 @param defaultText é»˜è®¤æç¤ºæ–‡æœ¬
 @param frame å¯ç”¨äºåŒºåˆ†å“ªä¸ªçª—å£è°ƒç”¨çš„
 @param completionHandler è¾“å…¥æ¡†æ¶ˆå¤±çš„æ—¶å€™è°ƒç”¨, å›è°ƒç»™JS, å‚æ•°ä¸ºè¾“å…¥çš„å†…å®¹
 */
- (void)webView:(WKWebView *)webView runJavaScriptTextInputPanelWithPrompt:(NSString *)prompt defaultText:(NSString *)defaultText initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(NSString * _Nullable))completionHandler {
    
    UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"è¯·è¾“å…¥" message:prompt preferredStyle:(UIAlertControllerStyleAlert)];
    [alert addTextFieldWithConfigurationHandler:^(UITextField * _Nonnull textField) {
        textField.placeholder = defaultText;
    }];
    
    // ç¡®è®¤æŒ‰é’®
    UIAlertAction *ok = [UIAlertAction actionWithTitle:@"ç¡®å®š" style:(UIAlertActionStyleDefault) handler:^(UIAlertAction * _Nonnull action) {
        UITextField *tf = [alert.textFields firstObject];
        completionHandler(tf.text);
    }];
    
    // å–æ¶ˆæŒ‰é’®
    UIAlertAction *cancel = [UIAlertAction actionWithTitle:@"å–æ¶ˆ" style:(UIAlertActionStyleCancel) handler:^(UIAlertAction * _Nonnull action) {
        completionHandler(defaultText);
    }];
    [alert addAction:ok];
    [alert addAction:cancel];
    [self presentViewController:alert animated:YES completion:nil];
}
```



----------
>  è¡Œè€…å¸¸è‡³ï¼Œä¸ºè€…å¸¸æˆï¼



