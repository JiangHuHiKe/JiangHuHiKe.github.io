---
layout: post
title: "iOS重签名"
date: 2019-01-20 
description: "iOS重签名"
tag: 编码及加解密
--- 

<h6>
  版权声明：本文为博主原创文章，未经博主允许不得转载。
  <a target="_blank" href="https://jianghuhike.github.io/190120.html">
  原文地址：https://jianghuhike.github.io/190120.html 
  </a>
</h6>



- [参考文章：https://www.jianshu.com/p/22f4a8f6dd1c](https://www.jianshu.com/p/22f4a8f6dd1c)

## 目录
* [签名](#content0)




<!-- ************************************************ -->
## <a id="content1"></a>签名


iOS的签名需要用到两对儿公私钥，一对儿由苹果公司提供，公钥内置在iPhone设备内，私钥在苹果后台。另一对儿由开发者提供，公钥最终会被签名成证书，私钥存储在开发者的Mac电脑内，通过xcode编译APP时会对APP进行签名，安装到手机时会进行验签，从而达到对安装包的管控。     
详细内容请参阅上篇博客[iOS签名原理](https://jianghuhike.github.io/190102.html)     

当我们的项目编译完成后，在Products文件夹内会看到编译好的.app格式的包xxx.app,对其右键显示包内容，我们看到文件夹内有**各种资源文件**、**Framworks文件夹**、**可执行文件**、还有一个**embedded.mobileprovision文件**（从App Store下载的安装包是没有这个文件的，因为从App Store下载的安装包的签名机制不同）、还有一个**_CodeSignature文件夹**。

<img src="/images/encrypted/sign7.png" alt="img">


**一、embedded.mobileprovision文件**

就是我们从苹果开发者网站下载的描述文件。文件包含几个部分：

说明部分：包含APP ID

ENTITLEMENTS:APP的权限说明，比如推送、健康

CERTIFICATES:证书信息，决定了APP是否合法，是否是苹果允许安装的APP，解决了非法APP问题。

PROVISIONED DEVICES:设备信息,决定了能在哪些设备上进行安装，解决了APP滥用问题。

当我们在设备上安装一个xxx.app时，如果安装失败，很大可能是因为验证阶段无法通过导致的。

举个例子：

当我们在一个非授权的设备上安装时，安装失败。因为embedded.mobileprovision文件验签成功后，要比对设备列表，当该设备不在列表内时，无法安装。


**二、CodeResources文件**

用文本编辑器打开该文件，发现其数据格式是xml格式，那么我们把文件加后缀.plist变为CodeResources.plist文件后用xcode打开。

<img src="/images/encrypted/sign8.png" alt="img">

<img src="/images/encrypted/sign9.png" alt="img">

<span style="color:red">可以看到该文件内是整个xxx.app包内的文件的哈希值和签名数据。</span>

1、下面我们先来验证下截图中的hash

通过以下指令查看文件AppIcon20x20@2x.png的SHA1值：
```
$ openssl dgst -sha1 AppIcon20x20@2x.png
SHA1(AppIcon20x20@2x.png)= 6a86ffb8b561ef861b7f89630d476aa2d404db35
```
可以看到截图中的hash值与我们终端中的值是一致的。

2、验证截图中的hash2

那么hash2又是什么值呢？先大胆猜测下，编译阶段xcode会用Mac上存储的私钥对APP进行签名，这个值应该就是用Mac私钥对hash值的签名数据。那么如何验证呢？我们使用该工程中用到的P12文件对hash值做一次签名，看得到的结果与hash2值是否一致来验证我们的猜想。




当我们在设备上安装一个xxx.app时，如果安装失败，可能是因为破坏了文件的哈希值。

举个例子：

当我们改变了包内的某一个图片时，安装会失败。因为这个图片的签名信息变了，验签时就会失败。


**三、安装**

当我们往一个设备安装时会经历以下几个阶段：

1、xxx.app拷贝到设备，xxx.app内有embedded.mobileprovision文件、CodeResources文件

2、苹果公钥验证embedded.mobileprovision是否是苹果签名过的文件。

3、验证设备IDs、APPID、Entitlements

4、苹果公钥验证证书是否是苹果签名的证书。

5、证书验证

<6a86ffb8 b561ef86 1b7f8963 0d476aa2 d404db35>

$ openssl dgst -sha1 AppIcon20x20\@2x.png
SHA1(AppIcon20x20@2x.png)= 6a86ffb8b561ef861b7f89630d476aa2d404db35











----------
>  行者常至，为者常成！



