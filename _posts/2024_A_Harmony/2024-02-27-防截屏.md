---
layout: post
title: "防截屏"
date: 2024-02-27
tag: Harmony
---

-[参考文章1：应用权限列表](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/permissions-for-all-0000001820999669)    
-[参考文章2：如何声明权限](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions-0000001820999665)    

## 目录
- [防截屏](#content1)   


<!-- ************************************************ -->
## <a id="content1">防截屏</a>


**一、先申请权限**  
在下面文件中添加权限      
/df-flutter/ohos/entry/src/main/module.json5      
```text
{
"name": "ohos.permission.PRIVACY_WINDOW",
"reason": "$string:get_oaid",
"usedScene": {
    "abilities": [],
    "when": "inuse"
   }
}
```

**二、设置隐私模式**  

```text
export class ShotScreenUtil {
  public static openPrivacyMode(context:Context,isPrivacyMode:boolean) {
    try {
      
      // 获取当前的window
      window.getLastWindow(context, (err: BusinessError, data) => {
        const errCode: number = err.code;
        if (errCode) {
          console.error('Failed to obtain the top window. Cause: ' + JSON.stringify(err));
          return;
        }
        console.info('Succeeded in obtaining the top window. Data: ' + JSON.stringify(data));

        // 设置当前window的隐私模式
        let windowClass = data;
        windowClass.setWindowPrivacyMode(isPrivacyMode, (err: BusinessError) => {
          const errCode: number = err.code;
          if (errCode) {
            console.error('Failed to set the window to privacy mode. Cause:' + JSON.stringify(err));
            return;
          }
          console.info('Succeeded in setting the window to privacy mode.');
        });
      });
    } catch (exception) {
      console.error('Failed to obtain the top window. Cause: ' + JSON.stringify(exception));
    }
  }
}
```
   
**三、如何使用**   
```text
// 页面显示的时候把隐私模式打开
.onShown(()=>{
  ShotScreenUtil.openPrivacyMode(getContext(this), true)
})
// 页面消失的时候把隐私模式关闭，如果不关闭，防截屏会在任何页面都开启
.onHidden(()=>{
  ShotScreenUtil.openPrivacyMode(getContext(this), false)
})
```

比如我们想全局开启防截屏模式的时候
```text
export class EntryAbility extends UIAbility {
    onWindowStageCreate(windowStage: window.WindowStage): void {
    
    }
}
```

**四、如果不想在每个页面都添加，可以在路由拦截中使用**   

```text
  public static createNavPathStack(navPathStack: NavPathStack): void {
    DfRouter.navPathStack = navPathStack;
    
    // 路由拦截回调
    navPathStack.setInterception({
      willShow: (from: NavDestinationContext | "navBar", to: NavDestinationContext | "navBar", operation: NavigationOperation, animated: boolean) => {
        if (typeof to === "string") {
          console.log("target page is navigation home page.");
          return;
        }

        ShotScreenUtil.openPrivacyMode(to);
      }
    })
  }
```

```text
export class ShotScreenUtil {
    
    
  //静态变量，存储Window对象
  private static windowClass : window.Window | null = null;
  public static init(windowClass: window.Window) {
    ShotScreenUtil.windowClass = windowClass;
  }


  // 根据传递过来的参数来动态决定是否开启隐私模式(防截屏)
  public static openPrivacyMode(target: NavDestinationContext) {
  
    //观察到：页面被push或pop都会携带，打开页面时传递给页面的参数
    let pageParam = target.pathInfo.param as Map<string,object | string>;
    
    
    let isPrivacyMode = false;

    if (pageParam && pageParam.has("source")) {
      let source:string = pageParam.get("source") as string;
      let userInfo = DfGlobalContext.getContext().getObject('currentUser') as UserInfoOa;
      let screenShotInfo = userInfo.screenshotInfo;
      if (screenShotInfo && screenShotInfo.screenshot == true) {
        screenShotInfo.sources?.forEach(element => {
          if (element == source) {
            isPrivacyMode = true;
          }
        })
      }
    }

    try {
      ShotScreenUtil.windowClass?.setWindowPrivacyMode(isPrivacyMode, (err: BusinessError) => {
        const errCode: number = err.code;
        if (errCode) {
          console.error('Failed to set the window to privacy mode. Cause:' + JSON.stringify(err));
          return;
        }
        console.info('Succeeded in setting the window to privacy mode.');
      });

    } catch (exception) {
      console.error('Failed to obtain the top window. Cause: ' + JSON.stringify(exception));
    }
  }
}
```




----------
>  行者常至，为者常成！


