---
layout: post
title: "性能优化"
date: 2023-02-13
tag: Overview
---





## 目录


- [启动优化](#content1)   
- [包大小优化](#content2)   
- [界面优化](#content3)   
- [内存优化](#content4)   



## <a id="content1">启动优化</a>

**启动的三个阶段**    
<span style="color:gray;font-size:12px;">
main函数之前 - main函数之后 - 首屏渲染完成后
<span>   


**main函数之前**   
<span style="color:gray;font-size:12px;"> 
加载可执行文件     
加载动态库(rebase 指针修正/binding 绑定具体的符号地址)       
进行类、分类的注册，将分类方法插入到类方法列表        
初始化：+load方法的调用，创建全局变量   
</span> 
优化手段    
<span style="color:gray;font-size:12px;">
减少动态库的使用       
减少不使用的分类代码       
减少+load方法的使用，比如方法交换可以放到+intiallize方法里      
</span>



**main函数之后**     
<span style="color:gray;font-size:12px;">
main函数执行开始到首屏开始绘制     
这一步主要是业务逻辑的梳理，只保留必须得初始化功能，比如登录状态管理，crash监控等    
非必须得功能延后，比如：埋点、统计、更新检测，这些可以在首屏渲染完成后(viewdidapear方法里)放在子线程初始化    
</span>    

**首屏渲染完成之后**     
<span style="color:gray;font-size:12px;">
用户已经能够看到界面，viewdidappear     
这里主要是防止界面卡住，因为用户已经能够看到，可能会进行滑动或点击操作。     
</span>
优化手段    
<span style="color:gray;font-size:12px;">
数据量较大时使用分页先加载少量数据    
异步加载图片     
还可以使用骨架屏，数据回来时填充页面     
</span>   


**衡量标准**   
<span style="color:gray;font-size:12px;">
instrument 里的 timer profile   
三方sdk  
</span>   


## <a id="content2">包大小优化</a>


**资源文件**     

图片处理     
<span style="color:gray;font-size:12px;">
1、asset管理     
使不同的设备只包含对应的图片，比如只包含3x，舍弃2x和1x图      
2、三方静态检测工具     
LSUnusedResources，FengNiao，可一帮助我们筛选出不用的图片和重复的图片。我们二次确认后进行删除      
3、使用png图片      
之前的Xcode有两个编译项Compress PNG Files 和 Remove Text Metadata From PNG Files 会对png图片进行压缩和去除非必要信息比如图片的作者、时间、注释信息等。现在的Xcode已经没有这两个选项，猜测是默认选项了。     
4、大图使用webp    
webp比png的压缩率更高渲染效果更好。       
</span>

其它资源文件处理    
<span style="color:gray;font-size:12px;">
1、压缩     
音视频或其它资源文件进行压缩，app启动后在合适的时机进行解压缩
<br>
2、远端化     
如果优先级不高可以远端化，放在服务端，在需要的时候进行下载
</span>    


**可执行文件**      
剥离符号表    
<span style="color:gray;font-size:12px;">
1、发布版本选择，dwarf with dsym file      
将调试符号表和可执行文件剥离，大方的调试符号表的大小在80M左右      
2、Xcode提供了很多strip相关的选项         
比如  dead code strip(链接阶段进行标记)， strip linked product(链接完成后进行剥离) 会将链接过程中未使用的符号进行清除 
</span>

剥离未使用代码    
<span style="color:gray;font-size:12px;">
1、在使用三方库的时候 配置other link flag ： -all_load、 -objc、 -force_load ，     
-objc会加载所有的分类代码，比如一些三方库写的一些颜色字符串等的扩展代码我们实际用不到也会被加载进来。-all_load除了加载所有的分类代码还会加载一些无用的c/c++代码增加包体积。我们可以使用 -force_load加载指定的三方库的分类代码而不是全部分类代码来达到减少包体积的效果         
可以配合link map 进行初步的锁定（linkmap可以看到加载了哪些分类，我们进行确认这些分类是否有真正使用。另外linkmap也可以看到哪些函数占用过大，正常函数占用大小在几十到几百字节，如果函数占用在几十KB，我们就需要优化这个函数实现，也可以减少包体积大小。函数内使用了大字符串常量，大数组，过多的ifelse都会导致函数过大）      
2、三方sdk使用子模块       
如果项目是组件化模式的推动其它团队发布子模块模式的库减少冗余代码的引入       
3、三方的静态分析工具       
帮助我们筛选出工程中未使用的代码       
4、代码段迁移           
mach-o文件中占比最大的部分是代码段，大字符串常量和重复字符串常量，数组、字典常量都会增加代码段。     
通过将这些常量变成资源文件，资源文件会被AppStore压缩，减少包体积     
通过配置相应的连接器参数，也可以对代码段进行优化：比如合并字符串常量    
</span>  



## <a id="content3">界面优化</a>


## <a id="content4">内存优化</a>


























----------
>  行者常至，为者常成！


