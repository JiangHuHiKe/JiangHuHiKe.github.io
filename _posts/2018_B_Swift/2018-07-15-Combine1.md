---
layout: post
title: "Combine 1"
date: 2018-07-15
description: ""
tag: Swift
---


## ç›®å½•

* [ä»‹ç»](#content1)
* [Publisher](#content2)
* [Operator](#content3)
* [Subscriber](#content4)


## <a id="content1">ä»‹ç»</a>

#### **ä¸€ã€æ˜¯ä»€ä¹ˆ**    
Combine æ˜¯ Apple åœ¨ iOS 13 / macOS 10.15 å¼•å…¥çš„ä¸€ä¸ª å“åº”å¼ç¼–ç¨‹æ¡†æ¶ã€‚    
æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„çš„æ•°æ®æµå¤„ç†æ¨¡å‹ï¼Œ<span style="color:red;font-weight:bold;"> Publisher â†’ Operator â†’ Subscriber</span>ã€‚     

#### **äºŒã€è§£å†³äº†ä»€ä¹ˆé—®é¢˜**    

**KVO / NotificationCenter / Delegate**         
å„ç§æœºåˆ¶åˆ†æ•£åœ¨ä¸åŒ APIï¼Œç¼ºä¹ç»Ÿä¸€æŠ½è±¡ï¼Œä½¿ç”¨combineæ¡†æ¶å°±å¯ä»¥ä¸ä½¿ç”¨ä¸Šè¿°æ–¹æ¡ˆäº†ã€‚     

**UI ä¸æ•°æ®ç»‘å®š**     
æ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–° UI     

**å›è°ƒåœ°ç‹±ï¼ˆcallback hellï¼‰**     
å¼‚æ­¥æ“ä½œåµŒå¥—å¤šå±‚å›è°ƒï¼Œå±‚å±‚åµŒå¥—ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚     
æ¯”å¦‚ä¸€ä¸ªè¯·æ±‚ä¾èµ–å¦ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œä¼šæœ‰ä¸¤å±‚åµŒå¥—ã€‚     

**å¼‚æ­¥ä»»åŠ¡çš„ç»„åˆ**    
æ¯”å¦‚è¦åŒæ—¶å‘èµ·ä¸¤ä¸ªç½‘ç»œè¯·æ±‚ï¼Œç­‰ä¸¤ä¸ªéƒ½å®Œæˆåå†å¤„ç†ã€‚    


#### **ä¸‰ã€æ ¸å¿ƒåŸç†æ˜¯ä»€ä¹ˆ**     

<span style= "color:red;font-weight:bold;">xy: combine  æ˜¯ä¸€ä¸ª å‘å¸ƒ-è®¢é˜… æ¨¡å¼çš„ æµæ¨¡å‹ï¼Œæ•°æ®ä»publisher æµå‘ operator æœ€ååˆ°è¾¾ subscriber,<br>publisherä½œä¸ºæ•°æ®æºï¼Œ<br>operatorå¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤æˆ–è½¬æ¢ï¼Œ<br>subscriberå¯¹æ•°æ®è¿›è¡Œæ¶ˆè´¹</span>   

Combine çš„æ ¸å¿ƒæ€æƒ³æ˜¯ å“åº”å¼æµæ¨¡å‹ï¼ˆReactive Streamsï¼‰ï¼Œç”¨â€œå‘å¸ƒ-è®¢é˜…â€æ¨¡å¼ï¼ˆPublisher-Subscriber Patternï¼‰ã€‚

åŸç†å…³é”®ç‚¹ï¼š

**Publisher (å‘å¸ƒè€…)**     
å®šä¹‰äº†å¯ä»¥å¼‚æ­¥å‘å‡ºçš„ä¸€ç³»åˆ—å€¼ï¼ˆåŒ…æ‹¬æ­£å¸¸å€¼ã€å®Œæˆäº‹ä»¶ã€é”™è¯¯ï¼‰ã€‚   
ç±»ä¼¼ä¸€ä¸ªâ€œæ•°æ®æºâ€ã€‚    

**Operator (æ“ä½œç¬¦)**    
è¿æ¥ Publisher å’Œ Subscriberã€‚    
é€šè¿‡é“¾å¼è°ƒç”¨ï¼Œç»„åˆ/è½¬æ¢æ•°æ®æµã€‚    

**Subscriber (è®¢é˜…è€…)**     
<span style="color:red;font-weight:bold;">è®¢é˜…åæ‰ä¼šè§¦å‘æ•°æ®æµã€‚</span>    
è´Ÿè´£æ¥æ”¶ Publisher å‘å‡ºçš„å€¼å’Œå®Œæˆ/é”™è¯¯äº‹ä»¶ã€‚     

**èƒŒå‹æœºåˆ¶ (Backpressure)**     
Subscriber å¯ä»¥è¯·æ±‚æ•°æ®çš„æ•°é‡ï¼Œé¿å… Publisher è¿‡å¿«äº§ç”Ÿæ•°æ®å¯¼è‡´èµ„æºè€—å°½ã€‚

**åŸºäº Swift æ³›å‹ + åè®®**    
Publisher å’Œ Subscriber éƒ½æ˜¯åè®®ã€‚    
Publisher æœ‰ Output å’Œ Failure ä¸¤ä¸ªå…³è”ç±»å‹ï¼Œç”¨äºå¼ºç±»å‹çº¦æŸã€‚    


## <a id="content2">Publisher</a>

#### **ä¸€ã€@Published**   

```swift
class ViewModel {
    
    @Published
    var text = "this is text"
}
```

```swift
// @Published ä¿®é¥°çš„Stringçš„è®¢é˜…,åªè¦textçš„å€¼å‘ç”Ÿå˜åŒ–å°±ä¼šè§¦å‘è®¢é˜…    
vm.$text.sink { complete in
    switch complete {
    case .finished :
        print("$text finished")
    case .failure(let error):
        print("$text failure:\(error)")
    }
} receiveValue: { value in
    print(value)
}.store(in: &cancellables)
```

#### **äºŒã€Subject**   

**1ã€PassthroughSubject**    

```swift 
class ViewModel {
    let passthroughSubjectPub = PassthroughSubject<String, Never>()
}
```

passthroughSubjectè®¢é˜…æ—¶ä¸ä¼šè§¦å‘å›è°ƒ    
```swift
// passthroughSubject çš„è®¢é˜…
vm.passthroughSubjectPub.sink { complete in
    switch complete {
    case .finished :
        print("passthroughSubject finished")
    case .failure(let error):
        print("passthroughSubject failure:\(error)")
    }
} receiveValue: { value in
    print(value)
}.store(in: &cancellables)
```

PassthroughSubjectï¼šåªè½¬å‘æ‰‹åŠ¨å‘é€çš„å€¼ï¼Œä¸ä¿å­˜å†å²ã€‚
```swift
 vm.passthroughSubjectPub.send("passthrough")
```

**2ã€CurrentValueSubject**   

CurrentValueSubjectï¼šå’Œ PassthroughSubject ç±»ä¼¼ï¼Œä½†ä¼šä¿ç•™æœ€è¿‘ä¸€ä¸ªå€¼

```swift 
class ViewModel {
    let currentValueSubjectPub = CurrentValueSubject<String, Never>("currentValue")
}
```

CurrentValueSubjectè®¢é˜…æ—¶ä¼šè§¦å‘å›è°ƒï¼Œè¿”å›å½“å‰å€¼
```swift
// currentValueSubject çš„è®¢é˜…
vm.currentValueSubjectPub.sink { complete in
    switch complete {
    case .finished :
        print("currentValueSubject finished")
    case .failure(let error):
        print("currentValueSubject failure:\(error)")
    }
} receiveValue: { value in
    print(value)
}.store(in: &cancellables)
```

```swift
vm.currentValueSubjectPub.send("currentValue")
```

#### **ä¸‰ã€è®¢é˜…åç«‹å³å‘å‡º**    

```swift
class ViewModel {
    // ä¸‹é¢è¿™äº›åªè¦è®¢é˜…å°±ä¼šç«‹å³æ”¶åˆ°ç»“æœ
    let justPub = Just("just")
    let emptyPub = Empty<Int,Never>()
    let failPub = Fail<Int, MyError>(error: .somethingWrong)
    let sequencePub = [1, 2, 3].publisher
}
```

Justï¼šç«‹å³å‘å‡ºä¸€ä¸ªå€¼å¹¶å®Œæˆã€‚åªè¦è®¢é˜…å°±ä¼šç«‹å³æ”¶åˆ°Justå‘å‡ºçš„å€¼    
```swift
vm.justPub.sink { complete in
    switch complete {
    case .finished :YI
        print("justPub finished")
    case .failure(let error):
        print("justPub failure:\(error)")
    }
} receiveValue: { value in
    print(value)
}.store(in: &cancellables)
```

Emptyï¼šä¸å‘ä»»ä½•å€¼ï¼Œç›´æ¥å®Œæˆã€‚åªè¦è®¢é˜…å°±ä¼šç«‹å³å®Œæˆ
```swift
vm.emptyPub.sink { complete in
    switch complete {
    case .finished :
        print("emptyPub finished")
    case .failure(let error):
        print("emptyPub failure:\(error)")
    }
} receiveValue: { value in
    print(value)
}.store(in: &cancellables)
```



## <a id="content3">Operator</a>

#### **ä¸€ã€filter**  
ç”¨äºè¿‡æ»¤æ•°æ®      
```swift
[10,20,30,40,50].publisher
    .filter({ value in
        // å¤§äº20çš„æ•°æ®è¿”å›ï¼Œå°äºç­‰äº20çš„æ•°æ®è¢«è¿‡æ»¤æ‰
        return value > 20
    })
    .sink { complete in
        switch complete {
            
        case .finished:
            print("finished")
            
        case .failure(let error):
            print("fail \(error)")
        }
    } receiveValue: { value in
        print(value)
    }.store(in: &cancellables)
```

#### **äºŒã€map**    

ç”¨äºæ˜ å°„æ•°æ®ï¼Œæˆ–æ•°æ®ç±»å‹è½¬æ¢     

```swift
static func fetchHomeLoginLazyPublisher(param: [String : Any]) -> AnyPublisher<HomeLogin?,NetworkError> {
    return Request().fetchDataLazyPublisher(
        urlStr: "https://mock.apipost.net/mock/51814f4a3871000/home/login",
        httpMethod: "POST",
        parameters: param
    ).map({(responseData:ResponseData<HomeLogin>) in
        responseData.data
    }).eraseToAnyPublisher()
}
```

#### **ä¸‰ã€flatMap**    
é“¾å¼è¯·æ±‚    
```swift
HomeRequest.fetchHomeOnceLazyPublisher()
    .map{ homeOnce in
        print("homeOnce is \(homeOnce, default: "")")
        return homeOnce?.once
    }
    .flatMap { once in
        let param: [String : Any] = [
            "once":once ?? "",
            "username":"jianghuhike",
            "password":"123456"
        ]
        return HomeRequest.fetchHomeLoginLazyPublisher(param: param)
    }
    .sink { complete in
        switch complete {
        case .failure(let error):
            print("æ•è·çš„é”™è¯¯ï¼š\(error)")
        case .finished:
            print("finish")
        }
    } receiveValue: { homeDes in
        print(homeDes ?? "data is nil")
    }
    .store(in: &cancellables)

```
å¹¶å‘æ§åˆ¶
```swift
let userIds = [1, 2, 3, 4, 5]
userIds.publisher
    .flatMap(maxPublishers: .max(2)) { id in
        print("user id is \(id)")
        return Just("user document \(id)") // å¹¶è¡Œè¯·æ±‚æ¯ä¸ªç”¨æˆ·çš„æ–‡ç« 
    }
    .collect()  // ç­‰æ‰€æœ‰å®Œæˆåæ”¶é›†ä¸º [Post]
    .sink(receiveCompletion: { print($0) },
          receiveValue: { allPosts in
              print("æ€»å…±è·å–åˆ° \(allPosts) ")
          })
    .store(in: &cancellables)
```

#### **å››ã€èŠ‚æµ**   

```swift
Timer.publish(every: 1.0, on: .main, in: .default)
    .autoconnect()
    .print("æ‰“å°æ—¥æœŸï¼š\(Date().description)")
    .throttle(for: 2.0, scheduler: RunLoop.main, latest: true)
    .sink(
        receiveCompletion: { print ("Completion: \($0).") },
        receiveValue: { print("Received Timestamp \($0).",terminator: "\n---------------------\n") }
    )
    .store(in: &cancellables)
```

èŠ‚æµï¼šæ»šåŠ¨ä½ç½®ä¸ŠæŠ¥     
```swift
scrollSubject
    .map { $0.y }
    .removeDuplicates()
    .throttle(for: .seconds(1), scheduler: RunLoop.main, latest: true)
    .sink { y in
        print("ğŸ“¡ (subject) æ»šåŠ¨ä½ç½®ä¸ŠæŠ¥: \(y)")
    }
    .store(in: &cancellables)
```

#### **äº”ã€é˜²æŠ–** 

é˜²æŠ–ï¼šæœç´¢æ¡†è¾“å…¥æ—¶ï¼Œå»¶è¿Ÿ0.5ç§’åæ‰å‘èµ·è¯·æ±‚    
```swift
NotificationCenter.default.publisher(for: UITextField.textDidChangeNotification, object: textField)
    .compactMap { ($0.object as? UITextField)?.text }
    .debounce(for: .milliseconds(500), scheduler: RunLoop.main) // é˜²æŠ–ï¼š0.5 ç§’
    .removeDuplicates() // å»é‡ï¼šé¿å…ç›¸åŒè¾“å…¥é‡å¤è§¦å‘
    .sink { [weak self] text in
        print("ğŸ” å¼€å§‹æœç´¢: \(text)")
        self?.search(keyword: text)
    }
    .store(in: &cancellables)

```



## <a id="content4">Subscriber</a>

#### **ä¸€ã€sink**    

åªæ¥æ”¶å®Œæˆåçš„å€¼    
```swift
[1, 2, 3].publisher
    .sink { value in
        print("value is \(value)")
    }
    .store(in: &cancellables)
```

æ¥æ”¶å®Œæˆäº‹ä»¶å’Œå®Œæˆåçš„å€¼    
```swift
[1,2,3].publisher
    .sink { complete in
        switch complete {
        case .finished:
            print("finieshe")
        case .failure(let error):
            print("error is \(error)")
        }
    } receiveValue: { value in
        print("value is \(value)")
    }
    .store(in: &cancellables)
```




----------
>  è¡Œè€…å¸¸è‡³ï¼Œä¸ºè€…å¸¸æˆï¼
