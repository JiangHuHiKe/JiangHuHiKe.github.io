---
layout: post
title: "9 é‡è¦æ–¹æ³•â­ï¸"
date: 2022-02-09
tag: Flutter
---


## ç›®å½•
- [didUpdateWidgetï¼šä»€ä¹ˆæ—¶å€™ä¼šè¢«è°ƒç”¨ï¼Ÿ](#content1)
- [updateç›¸å…³æ–¹æ³•](#content2)  
- [didChangeDependencies](#content3)  



## <a id="content1">didUpdateWidgetï¼šä»€ä¹ˆæ—¶å€™ä¼šè¢«è°ƒç”¨ï¼Ÿ</a>

#### **ä¸€ã€è§¦å‘çš„å®Œæ•´æ¡ä»¶**
1ã€<span style="color:red;">çˆ¶ widget è§¦å‘ rebuild</span>             
2ã€Flutter å†³å®šã€Œå¤ç”¨æ—§ Elementã€        
3ã€æ–° widget != old widgetï¼ˆé…ç½®å‘ç”Ÿå˜åŒ–ï¼‰         
å°‘ä¸€ä¸ªéƒ½ä¸ä¼šè¿› didUpdateWidget

<span style="color:red;">å¦‚æœwidgetæ˜¯ const ä¿®é¥°ï¼Œä¸ä¼šè¿›å…¥è¯¥æ–¹æ³•ï¼Œä¹Ÿä¸ä¼šèµ°stateçš„buildçš„æ–¹æ³•</span>

#### **äºŒã€å…¸å‹ä½¿ç”¨åœºæ™¯**

å¤–éƒ¨å‚æ•°å˜åŒ–ï¼Œéœ€è¦åŒæ­¥å†…éƒ¨çŠ¶æ€

```text
class Counter extends StatefulWidget {
  final int initial;

  const Counter({super.key, required this.initial});

  @override
  State<Counter> createState() => _CounterState();
}

class _CounterState extends State<Counter> {
  late int value;

  // initState åªè·‘ä¸€æ¬¡   
  @override
  void initState() {
    super.initState();
    value = widget.initial;
  }

  @override
  void didUpdateWidget(covariant Counter oldWidget) {
    super.didUpdateWidget(oldWidget);

    if (oldWidget.initial != widget.initial) {
      value = widget.initial; // åŒæ­¥æ–°é…ç½®
    }
  }

  // didUpdateWidget è´Ÿè´£â€œé…ç½®æ›´æ–°â€ 
  @override
  Widget build(BuildContext context) {
    return Text('$value');
  }
}
```

#### **ä¸‰ã€å¸¸è§è¯¯åŒºï¼ˆé‡ç‚¹ï¼‰**
å¤–éƒ¨åˆ·æ–°æ—¶ï¼Œå…ˆè°ƒç”¨didUpdateWidgetåœ¨è°ƒç”¨buildã€‚     
å†…éƒ¨çš„ setState ä¸ä¼šè§¦å‘ didUpdateWidgetã€‚         
build ä¸ä¼šè°ƒç”¨ didUpdateWidgetã€‚      
StatelessWidget ä¸éœ€è¦åˆ·æ–°ï¼Œçˆ¶ç±»rebuildæ—¶ï¼Œå®ƒä¼šç›´æ¥åˆ›å»ºæ–°çš„ã€‚æ²¡æœ‰didUpdateWidgetæ–¹æ³•ã€‚



## <a id="content2">updateç›¸å…³æ–¹æ³•</a>

å‡è®¾éƒ½æ˜¯æ™®é€š Widgetï¼ˆæ—  keyï¼‰
```text
A
 â””â”€ B
     â””â”€ C
```
Element æ ‘ï¼ˆç¬¬ä¸€æ¬¡ build åï¼‰
```text
ElementA(widget: A1)
 â””â”€ ElementB(widget: B1)
     â””â”€ ElementC(widget: C1)
```
1ï¸âƒ£ çˆ¶çº§ setState
```text
A2  // æ–°çš„ Widget å®ä¾‹
```
Flutter åšçš„æ˜¯ï¼š
```text
ElementA.update(A2)
```
äºæ˜¯ï¼š
```text
ElementA.widget = A2
```
2ï¸âƒ£ ElementA è°ƒç”¨ performRebuild()

æ¥ä¸‹æ¥ï¼š

```text
ElementA.performRebuild()
```

å†…éƒ¨åšä¸€ä»¶äº‹ï¼š   
```text
Widget newChild = A2.build(context);
```

å‡è®¾ build ç»“æœæ˜¯ï¼š     
```text
B2
```

3ï¸âƒ£ å…³é”®ä¸€æ­¥ï¼šupdateChildï¼ˆA â†’ Bï¼‰    
```text
ElementA.updateChild(
oldChild: ElementB,
newWidget: B2,
)
```

Flutteråˆ¤æ–­ï¼š     
```text
canUpdate(B1, B2)
= runtimeType ç›¸åŒ
= key ç›¸åŒï¼ˆnullï¼‰
```

âœ… å¯ä»¥å¤ç”¨,äºæ˜¯æ‰§è¡Œï¼š     
```text
ElementB.update(B2)
```

â¡ï¸ å…³é”®åŠ¨ä½œå‘ç”Ÿäº†   
```text
ElementB.widget = B2
```

ğŸ“Œ é‡ç‚¹ï¼š     
B çš„ Element æ²¡æ¢ï¼Œåªæ˜¯ Widget å¼•ç”¨ä» B1 æ¢æˆäº† B2


## <a id="content3">didChangeDependencies</a>

#### **ä¸€ã€è°ƒç”¨æ—¶æœº**     
1ã€State ç¬¬ä¸€æ¬¡æ’å…¥ Element æ ‘æ—¶
```text
initState
â†“
didChangeDependencies   âœ…
â†“
build
```

2ã€ä¾èµ–çš„ InheritedWidget å‘ç”Ÿå˜åŒ–æ—¶    
<span style="color:gray;font-size:12px;">
ç³»ç»Ÿå­—ä½“ç¼©æ”¾æ”¹å˜    
å±å¹•æ—‹è½¬ï¼ˆMediaQuery å˜åŒ–ï¼‰       
Theme åˆ‡æ¢ï¼ˆæ·±è‰² / æµ…è‰²ï¼‰       
Provider ä¸­çš„æ•°æ®æ›´æ–°    
</span>

#### **äºŒã€å…¸å‹ç¤ºä¾‹**    

```text
class MyWidget extends StatefulWidget {
  @override
  State<MyWidget> createState() => _MyWidgetState();
}

class _MyWidgetState extends State<MyWidget> {
  late Color textColor;

  @override
  void didChangeDependencies() {
    super.didChangeDependencies();

    // ä¾èµ– Theme
    textColor = Theme.of(context).textTheme.bodyLarge!.color!;
    print('didChangeDependencies');
  }

  @override
  Widget build(BuildContext context) {
    return Text(
      'Hello',
      style: TextStyle(color: textColor),
    );
  }
}
```

```text
MaterialApp(
  theme: ThemeData.light(),
  darkTheme: ThemeData.dark(),
)
```

#### **ä¸‰ã€ç»“åˆ Element æ›´æ–°æœºåˆ¶**   

```text
å½“åœ¨ build é‡Œå†™ï¼š
Theme.of(context)      

åº•å±‚å‘ç”Ÿçš„æ˜¯ï¼š
Element.dependOnInheritedElement(...)     
```

è¿™æ„å‘³ç€ï¼šå½“å‰ Element ç™»è®° äº†ä¸€ä¸ªä¾èµ–     
InheritedWidget æ›´æ–°æ—¶ï¼š     
<span style="color:gray;font-size:12px;"> 
ä¸ä¼šé‡å»ºæ•´æ£µæ ‘,ä¸ä¼šé”€æ¯ MyWidget          
åªé€šçŸ¥â€œä¾èµ–å®ƒçš„ Elementâ€,ç„¶åå›è°ƒ ğŸ‘‰ didChangeDependencies    
</span>    

#### **å››ã€ä»€ä¹ˆæ—¶å€™â€œåº”è¯¥â€ç”¨ didChangeDependenciesï¼Ÿ**    

**âœ… é€‚åˆæ”¾åœ¨è¿™é‡Œçš„é€»è¾‘**    
ä¾èµ– Theme / MediaQuery / Locale / Provider    
éœ€è¦åœ¨ä¾èµ–å˜åŒ–æ—¶é‡æ–°è®¡ç®—ä¸€æ¬¡çš„å€¼    
ä¸æƒ³åœ¨ build é‡Œåå¤ç®—    

**âŒ ä¸é€‚åˆ**     
çˆ¶ Widget å‚æ•°å˜åŒ–ï¼ˆç”¨ didUpdateWidgetï¼‰      
ä¸€æ¬¡æ€§åˆå§‹åŒ–ï¼ˆç”¨ initStateï¼‰      
UI æ¸²æŸ“ï¼ˆç”¨ buildï¼‰   





----------
>  è¡Œè€…å¸¸è‡³ï¼Œä¸ºè€…å¸¸æˆï¼


