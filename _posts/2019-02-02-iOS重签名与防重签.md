---
layout: post
title: "iOS重签名与防重签"
date: 2019-02-02 
description: "iOS重签名与防重签"
tag: 编码及加解密
--- 

<h6>
  版权声明：本文为博主原创文章，未经博主允许不得转载。
  <a target="_blank" href="https://jianghuhike.github.io/1922.html">
  原文地址：https://jianghuhike.github.io/1922.html 
  </a>
</h6>



## 目录
* [重签名](#content0)
* [防重签](#content0)




有了前两篇    
[iOS签名原理](https://jianghuhike.github.io/190102.html)、    
[iOS签名与验签逻辑](https://jianghuhike.github.io/190120.html)     
的理论与实践介绍，我们来看看如何对一个APP进行重签名和防止重签名。

<!-- ************************************************ -->
## <a id="content1"></a>重签名

当我们拿到一个xxx.ipa包，想要在未授权的设备上安装或者修改包内容后在设备上安装时，这时会因为验签失败导致无法安装，这时我们就需要对这个包解压得到xxx.app然后进行重签名。

要对一个APP签名需要三个东西：

**Code Signing Entitlements**：yyy.entitlements文件,提供APP的权限

**Code Signing Identity**：iPhone Developer yyy(JBLSRC6F92)带私钥的证书,签名APP包

**Provisioning Profile**:描述文件，用于验签

这三样东西从哪来，当然是从我们自己有权限的APP中来获得。

**1、Provisioning Profile的获取**

从我们自己的yyy.app包内显示包内容取出embedded.mobileprovision文件，或者从开发者网站下载后改名为embedded.mobileprovision，替换xxx.app包内的embedded.mobileprovision文件，用于安装时验签。

**2、Code Signing Identity的获取**

该证书（带私钥）位于我们的Mac，可从钥匙串中查看例如 iPhone Developer yyy(JBLSRC6F92),或者可以使用证书的ID

<img src="/images/encrypted/sign13.png" alt="img">

sha-1 就是该证书的ID。也可以通过指令在终端查看可用于签名的证书的id
```
security find-identity -v -p codesigning
```
Find an identity valid (certificate + private key).

```
$ security find-identity -v -p codesigning
  1) 308C7A35228D405EDA378BDA0412C9ED389528E5 "iPhone Developer: xxxx (xxxx)"
  2) 6AF7DAC8855CEF993AD8C6AF53AEF059A2CB26C8 "iPhone Distribution: xxxx Service co. LTD."
  3) 1D2879BD015CD866CB900745A49AFC32252CA381 "Apple Development: xxxx (xxxx)"
  4) 09AD074572F7EFC14E306B5BD92C90B4656D474D "iPhone Developer: xxxx (xxxx)"
  5) 6CC46A30E4CC1C906C4EBBD60D97CC20DCB8A8A3 "iPhone Developer: xxxx@yeah.net (xxxx)"
  6) 49BA747E31E484EB62CF6C82B7677357BE5A4BD2 "iPhone Distribution: xxxx Co., Ltd. (xxxx)"
  7) 459875A0ED41818E3EA7A25F962AFFADC5836591 "Mac Developer: xxxx@qq.com (xxxx)"
  8) 1ED104EDD7E3C72A0FE891AE6CE3A66197602C95 "Apple Development: xxxx (xxxx)"
  9) 8A58379560579700A1C2660F086E0DA1C4D9C655 "Apple Development: xxxx@yeah.net (xxxx)"
  9 valid identities found
  ```

**3、Code Signing Entitlements获取**

yyy.entitlements中的权限必须与embedded.mobileprovision中的权限匹配，所以我们从embedded.mobileprovision中提取权限文件。

```
security cms -D -i embedded.mobileprovision > temp.plist
/usr/libexec/PlistBuddy -x -c 'Print:Entitlements' temp.plist > entitlements.plist
```

**4、重签名**

如果xxx.app包内有Frameworks文件夹需要先对xxx.app内部的动态库、AppExtension等进行签名
```
codesign -fs 证书ID *.dylib     //对所有的dylib进行签名
codesign -fs 证书ID *.framwork  //对所有的framework进行重签名
```
然后对xxx.app包进行重签名
```
codesign -fs 证书ID --entitlements entitlements.plist xxx.app
```

到此重签名已经完成，xxx.app就可以在我们自己的设备上安装了。




<!-- ************************************************ -->
## <a id="content1"></a>防重签

那么如何防止我们开发的APP被别人重签呢？方式有很多种，在此说下我们自己的app是如何防止重签的。







----------
>  行者常至，为者常成！



