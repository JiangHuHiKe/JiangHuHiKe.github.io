---
layout: post
title: "LLVM（二）：编译过程"
date: 2019-03-10 
description: "LLVM（二）：编译过程"
tag: 工具
--- 

<h6>
  版权声明：本文为博主原创文章，未经博主允许不得转载。
  <a target="_blank" href="https://jianghuhike.github.io/19310.html">
  原文地址：https://jianghuhike.github.io/19310.html 
  </a>
</h6>

- [参考文章：llvm](https://www.jianshu.com/p/72bbcb8d109a)
- [参考文章：ios编译过程](https://www.jianshu.com/p/3c51a42b87a6)





## 目录
* [编译过程查看](#content1)
* [编译过程](#content2)

<!-- ************************************************ -->
## <a id="content1"></a> 编译过程查看

main.m文件内容如下
```
#import <Foundation/Foundation.h>
#import "Person.h"

#define AGE (18)

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        int a = 10;
        int b = 20;
        int c = a+b+AGE;
        print("c = %d\n",c);
    }
    return 0;
}
```

查看main.m文件的执行过程     
```
clang -ccc-print-phases main.m
```

执行过程如下
```
$ clang -ccc-print-phases -framework Foundation main.m -o main
0: input, "Foundation", object                //导入Foundation框架
1: input, "main.m", objective-c               //导入源文件
2: preprocessor, {1}, objective-c-cpp-output  //预处理
3: compiler, {2}, ir                          //编译生成IR(中间代码)
4: backend, {3}, assembler                    //汇编器生成汇编代码
5: assembler, {4}, object                     //生成机器码
6: linker, {0, 5}, image                      //链接
7: bind-arch, "x86_64", {6}, image            //生成Image，也就是最后的可执行文件
```

接着，就可以在终端直接运行这个程序了：
```
$ ./main
```

<!-- ************************************************ -->
## <a id="content2"></a> 编译过程

**一、预处理**

指令
```
clang -E main.m -o emain.m
```

emain.m文件如下
```
@interface Person : NSObject

@end

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        int a = 10;
        int b = 20;
        int c = a+b+(18);
        print("c = %d\n",c);
    }
    return 0;
}
```
替换了Person.h文件的内容和宏定义

**二、生成中间代码IR**
```
clang -S -emit-llvm main.m -o irmain.m
```
irmain.m文件的部分内容
```
Function Attrs: noinline optnone ssp uwtable
define i32 @main(i32, i8**) #0 {
  %3 = alloca i32, align 4
  %4 = alloca i32, align 4
  %5 = alloca i8**, align 8
  %6 = alloca i32, align 4
  %7 = alloca i32, align 4
  %8 = alloca i32, align 4
  store i32 0, i32* %3, align 4
  store i32 %0, i32* %4, align 4
  store i8** %1, i8*** %5, align 8
  %9 = call i8* @llvm.objc.autoreleasePoolPush() #1
  store i32 10, i32* %6, align 4
  store i32 20, i32* %7, align 4
  %10 = load i32, i32* %6, align 4
  %11 = load i32, i32* %7, align 4
  %12 = add nsw i32 %10, %11
  %13 = add nsw i32 %12, 18
  store i32 %13, i32* %8, align 4
  %14 = load i32, i32* %8, align 4
  %15 = call i32 (i8*, i32, ...) bitcast (i32 (...)* @print to i32 (i8*, i32, ...)*)(i8* getelementptr inbounds ([8 x i8], [8 x i8]* @.str, i32 0, i32 0), i32 %14)
  call void @llvm.objc.autoreleasePoolPop(i8* %9)
  ret i32 0
}
```


----------
>  行者常至，为者常成！



