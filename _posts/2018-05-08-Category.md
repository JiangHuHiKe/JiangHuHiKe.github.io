---
layout: post
title: "Category"
date: 2018-05-08
description: "NSObject的本质"
tag: 底层原理
---


<h6>
  版权声明：本文为博主原创文章，未经博主允许不得转载。
  <a target="_blank" href="https://jianghuhike.github.io/1858.html">
  原文地址：https://jianghuhike.github.io/1858.html 
  </a>
</h6>


## 目录
- [实现原理](#content1) 
- [+load方法](#content2) 


<!-- ************************************************ -->
## <a id="content1"></a>实现原理

Category编译之后的底层结构是struct category_t,里面存储着分类的<span style="color:red">对象方法、类方法、属性、协议信息</span>，在程序<span style="color:red">运行的</span>时候，runtime将Category的数据，合并到类信息中（类对象、元类对象中）。

定义在objc-runtime-new.h中的Category的结构
```objc
struct category_t {
    const char *name;
    classref_t cls;
    struct method_list_t *instanceMethods;
    struct method_list_t *classMethods;
    struct protocol_list_t *protocols;
    struct property_list_t *instanceProperties;
    // Fields below this point are not always present on disk.
    struct property_list_t *_classProperties;

    method_list_t *methodsForMeta(bool isMeta) {
        if (isMeta) return classMethods;
        else return instanceMethods;
    }

    property_list_t *propertiesForMeta(bool isMeta, struct header_info *hi);
};
```

通过runtime加载某个类的所有Category数据，把所有Category的方法、属性、协议数据，合并到一个大数组中，后边参与编译的Category数据，会在数组的前面。将合并后的分类数据（方法、属性、协议），插入到类原来的数据前面。<span style="color:red">所以分类里边的方法会覆盖类原来的方法，分类里边后编译的文件里的方法会覆盖前边编译的方法</span>

文件的编译顺序
<img src="/images/underlying/oc11.png" alt="img">

在三个文件里同时实现下面的方法：
```objc
-(void)test{
    NSLog(@"%s",__func__);
}
```
查看调用日志
```objc
-[Person(eat) test]
```


<!-- ************************************************ -->
## <a id="content2"></a>+load方法
+load方法会在runtime加载类、分类时调用，每个类、分类的+load方法，<span style="color:red">在程序运行过程中只调用一次。</span>      
调用顺序：    
1.先调用类的+load方法，类的+load方法的调用顺序按类的编译顺序调用，先编译先调用。但在调用之前会先调用父类的+load方法。      
2.再调用分类的+load方法，分类的+load方法的调用顺序按分类的编译顺序调用，先编译先调用。     

文件的编译顺序
<img src="/images/underlying/oc12.png" alt="img">

在五个文件里同时实现下面的方法：
```objc
+(void)load{
    NSLog(@"%s",__func__);
}
```

查看日志调用    
```objc
+[Person load]
+[Student load]
+[Person(run) load]
+[Person(eat) load]
+[Student(study) load]
```

<span style="color:red">+load方法是根据方法地址直接调用，并不是经过objc_msgSend函数调用</span>



----------
>  行者常至，为者常成！


